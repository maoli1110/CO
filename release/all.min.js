"use strict";function parsePercent(number){var persent=1e4*number,strName=parseInt(persent)+"",length=strName.length,integer=strName.substr(0,length-2),decimal=strName.substr(length-2,length);return""===integer&&(integer="0"),""===decimal?integer+"%":integer+"."+decimal+"%"}function allSelectStatus(){var isChecked=0;$(".check-now input[type=checkbox]").each(function(){this.checked&&isChecked++}),isChecked==$(".check-now input[type=checkbox]").length?$(".pull-left input[type=checkbox]:first").prop("checked",!0):$(".pull-left input[type=checkbox]:first").prop("checked",!1)}ApplicationConfiguration.registerModule("core"),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/cooperation"),$stateProvider.state("login",{url:"/",templateUrl:"template/core/login.html",data:{displayName:"login"}})}]);var clickCount=0;angular.module("core").controller("headerCtrl",function($scope,headerService,$state,Cooperation){$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){clickCount>0&&($(".header_menus").slideToggle("fast"),$(".headerMask").show(),$(".header_menus ul li").hover(function(){$(this).css({color:"#69c080"}).children().find("ol").show()},function(){$(this).css({color:"#333"}).children().find("ol").hide(),$(".header-shape").removeClass("dispatcher-database")}),$(".header_menus").mouseleave(function(){$(".header_menus").hide(),$(".headerMask").hide()})),$(".header-shape").click(function(){$(".headerMask").show(),$(".header_menus").slideToggle("fast"),$(".header_menus ul li").hover(function(){$(this).css({color:"#69c080"}).children().find("ol").show()},function(){$(this).css({color:"#333"}).children().find("ol").hide(),$(".header-shape").removeClass("dispatcher-database")}),$(".header_menus").mouseleave(function(){$(".header_menus").hide(),$(".headerMask").hide()})})}),$scope.headerMenus=[],$scope.menus=function(){$(".header-shape").toggleClass("dispatcher-database"),$(".header-shape").hasClass("dispatcher-database")&&(clickCount++,headerService.enterpriseInfoList({epid:0,isAll:3,queryFromBV:!1}).then(function(data){$scope.headerMenus=data.data}))},$scope.currentUser={img:"",name:"",job:"",compName:""},headerService.currentUserInfo().then(function(data){$scope.currentUser.img=data.avatarUrl,$scope.currentUser.name=data.userName,$scope.currentUser.job=data.roleName,$scope.currentUser.compName=data.enterpriseName}),$scope.minimize=function(){BimCo.SysCommand("SC_MINIMIZE")},$scope.maxRestore=function($event){BimCo.SysCommand("SC_MAXIMIZE")},$scope.close=function(){BimCo.SysCommand("SC_CLOSE")},$scope.switchCompany=function(enterpriseId){BimCo.ChangeEnterprise(enterpriseId)},$scope.transCoManageFrombe=function(){$state.go("cooperation",{deptId:"",ppid:""},{reload:!0})},Cooperation.heartBeat(),$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){clearInterval(ApplicationConfiguration.refreshID)})}),angular.module("core").directive("profit",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.$last===!0&&$timeout(function(){scope.$emit("ngRepeatFinished")})}}}),angular.module("core").directive("profitDept",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.$last===!0&&$timeout(function(){scope.$emit("ngRepeatFinishedDept")})}}}),angular.module("core").directive("profitSwitch",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.$last===!0&&$timeout(function(){scope.$emit("ngRepeatFinishedSwitch")})}}}),angular.module("core").directive("getCooperlist",function($timeout){return{restrict:"A",link:function(scope,element,attr){element.bind("click",function(){})}}}),angular.module("core").directive("copyRadio",function($timeout){return{restrict:"AE",link:function(scope,ele,attr){$(".new_cooper").click(function(){$(".data_count").hide()}),$(".data_back").click(function(){$(".data_count").hide(),$(".table-list.basic-project").show(),$(".table-list.draft-box").hide()}),$(".select-person-responsible-modal .person-list").on("click",".checkA",function(){$(".user-chioce").hide(),$(this).find(".user-chioce").show()}),$(".select-person-related-modal .left .person-list").on("click",".select-check",function(){$("li ").css("background","#fff"),$(this).find(".user-chioce").show(),$(this).css("background","#eceef0")}),$(".edit-related .left .person-list").on("click",".select-check",function(){$("li ").css("background","#fff"),$(this).find(".user-chioce").show(),$(this).css("background","#eceef0")})}}}),angular.module("core").directive("showIcon",function(){return{restrict:"AE",link:function(scope,ele,attr){$(".navbar-nav li").click(function(){$(this).addClass("navActive").siblings().removeClass("navActive")})}}}),angular.module("core").directive("ngThumb",["$window",function($window){var helper={support:!(!$window.FileReader||!$window.CanvasRenderingContext2D),isFile:function(item){return angular.isObject(item)&&item instanceof $window.File},isImage:function(file){var type="|"+file.type.slice(file.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(type)!==-1}};return{restrict:"A",template:"<canvas/>",link:function(scope,element,attributes){function onLoadFile(event){var img=new Image;img.onload=onLoadImage,img.src=event.target.result}function onLoadImage(){var width=params.width||this.width/this.height*params.height,height=params.height||this.height/this.width*params.width;canvas.attr({width:width,height:height}),canvas[0].getContext("2d").drawImage(this,0,0,width,height)}if(helper.support){var params=scope.$eval(attributes.ngThumb);if(helper.isFile(params.file)&&helper.isImage(params.file)){var canvas=element.find("canvas"),reader=new FileReader;reader.onload=onLoadFile,reader.readAsDataURL(params.file)}}}}}]),angular.module("core").directive("scrollDirective",function(){return{restrict:"AE",link:function(scope,ele,attr){var sideHeight=$(window).height()-124;$("#content-a2").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,theme:"minimal"}),$("#content-a3").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:$(window).height()-52,theme:"minimal"}),$("#content-a4").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a5").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a6").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a7").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a8").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a9").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a10").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,theme:"minimal"}),$("#content-a11").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a12").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a13").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#content-a14").mCustomScrollbar({setHeight:sideHeight,theme:"minimal"}),$("#content-a15").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,theme:"minimal"}),$("#content-a16").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,theme:"minimal"}),$("#detail-1").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,theme:"minimal"}),$("#content-b1").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:5,setHeight:$(window).height()-52,theme:"minimal",advanced:{updateOnBrowserResize:!1}}),$("#content-b2").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:sideHeight,theme:"minimal"}),$("#statistic_marker").mCustomScrollbar({mouseWheelPixels:200,scrollAmount:10,scrollSpeed:10,setHeight:240,theme:"minimal"}),$("#content-b7").mCustomScrollbar({setHeight:sideHeight,theme:"minimal"}),$("#content-b8").mCustomScrollbar({theme:"minimal"})}}}),angular.module("core").directive("lightHeight",function(){return{restrict:"AE",link:function(scope,ele,attr){jQuery.fn.highlight=function(pat){function innerHighlight(node,pat){var skip=0;if(3==node.nodeType){var pos=node.data.toUpperCase().indexOf(pat);if(pos>=0){var spannode=document.createElement("span");spannode.className="highlight";var middlebit=node.splitText(pos),middleclone=(middlebit.splitText(pat.length),middlebit.cloneNode(!0));spannode.appendChild(middleclone),middlebit.parentNode.replaceChild(spannode,middlebit),skip=1}}else if(1==node.nodeType&&node.childNodes&&!/(script|style)/i.test(node.tagName))for(var i=0;i<node.childNodes.length;++i)i+=innerHighlight(node.childNodes[i],pat);return skip}return this.each(function(){innerHighlight(this,pat.toUpperCase())})},jQuery.fn.removeHighlight=function(){function newNormalize(node){for(var i=0,children=node.childNodes,nodeCount=children.length;i<nodeCount;i++){var child=children[i];if(1!=child.nodeType){if(3==child.nodeType){var next=child.nextSibling;if(null!=next&&3==next.nodeType){var combined_text=child.nodeValue+next.nodeValue,new_node=node.ownerDocument.createTextNode(combined_text);node.insertBefore(new_node,child),node.removeChild(child),node.removeChild(next),i--,nodeCount--}}}else newNormalize(child)}}return this.find("span.highlight").each(function(){var thisParent=this.parentNode;thisParent.replaceChild(this.firstChild,this),newNormalize(thisParent)}).end()}}}}),angular.module("core").directive("boxShadow",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.$last===!0&&$timeout(function(){scope.$emit("shadowFinsh")})}}}),angular.module("core").directive("detail",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.$last===!0&&$timeout(function(){scope.$emit("detailTools")})}}}),angular.module("core").directive("attrSelect",function($timeout){return{restrict:"AE",link:function(scope,element,attr){$timeout(function(){$(".selectpicker").selectpicker({style:"btn-default",width:"102px"})},0)}}}),angular.module("core").directive("showSelect",function($timeout){return{restrict:"AE",link:function(scope,element,attr){$timeout(function(){$(".selectpicker").selectpicker({style:"",size:"auto"})},0)}}}),angular.module("core").directive("pcOperation",function(){return{restrict:"AE",link:function(scope,element,attr){$(".btn_box_pc").click(function(){$(".show_btn").toggleClass("glyphicon-menu-left"),$(".content_right_pc").toggleClass("menus"),$(".content_right_pc").hasClass("menus")?($("body").css("overflow-y","hidden"),$(".btn_box_pc").animate({right:"260px"}),$(".content_right_pc").animate({right:"0"}),$(".glyphicon-menu-right").css("display","inline-block"),$(".mobile-mark").show()):($("body").css("overflow-y","auto"),$(".btn_box_pc").animate({right:"0"}),$(".content_right_pc").animate({right:"-260px"}),$(".glyphicon-menu-right").css("display","none"),$(".mobile-mark").hide())}),$(".mobile-mark").click(function(){$(".show_btn").toggleClass("glyphicon-menu-left"),$(".content_right_pc").toggleClass("menus"),$(".content_right_pc").hasClass("menus")?($("body").css("overflow-y","hidden"),$(".btn_box_pc").animate({right:"260px"}),$(".content_right_pc").animate({right:"0"}),$(".glyphicon-menu-right").css("display","inline-block"),$(".mobile-mark").show()):($("body").css("overflow-y","auto"),$(".btn_box_pc").animate({right:"0"}),$(".content_right_pc").animate({right:"-260px"}),$(".glyphicon-menu-right").css("display","none"),$(".mobile-mark").hide())})}}}),angular.module("core").directive("bvOperation",function($document){return{restrict:"AE",link:function(scope,element,attr){var rightDistance=document.getElementsByClassName("content_right_bv")[0].offsetWidth;document.getElementsByClassName("paly-model")[0].offsetWidth;$(".btn_box_bv").click(function(){console.log("rightDistance1",rightDistance),$(".show_btn").toggleClass("glyphicon-menu-left"),$(".content_right_bv").toggleClass("menus"),$(".content_right_bv").hasClass("menus")?($("body").css("overflow-y","hidden"),$("body").css("position","fixed"),$(".btn_box_bv").animate({right:rightDistance}),$(".content_right_bv").animate({right:"0"}),$(".glyphicon-menu-right").css("display","inline-block"),$(".mobile-mark").show()):($("body").css("overflow-y","auto"),$("body").css("position",""),$(".btn_box_bv").animate({right:"0"}),$(".content_right_bv").animate({right:-rightDistance}),$(".glyphicon-menu-right").css("display","none"),$(".mobile-mark").hide())}),$(".mobile-mark").click(function(){$(".show_btn").toggleClass("glyphicon-menu-left"),$(".content_right_bv").toggleClass("menus"),$(".content_right_bv").hasClass("menus")?($("body").css("overflow-y","hidden"),$("body").css("position","fixed"),$(".btn_box_bv").animate({right:rightDistance}),$(".content_right_bv").animate({right:"0"}),$(".glyphicon-menu-right").css("display","inline-block"),$(".mobile-mark").show()):($("body").css("overflow-y","auto"),$("body").css("position",""),$(".btn_box_bv").animate({right:"0"}),$(".content_right_bv").animate({right:-rightDistance}),$(".glyphicon-menu-right").css("display","none"),$(".mobile-mark").hide())})}}}),window.onresize=function(){$(" #content-a3").height($(window).height()-52),$(" #content-b1").height($(window).height()-52)},angular.module("core").directive("draggable",["$document",function($document){return function(scope,element,attr){function mousemove(event){y=event.pageY-startY,x=event.pageX-startX,element.css({top:y+"px",left:x+"px"})}function mouseup(){$document.off("mousemove",mousemove),$document.off("mouseup",mouseup)}var startX=0,startY=0,x=0,y=0;element=angular.element(document.getElementsByClassName("modal-dialog")),element.css({position:"relative",cursor:"move"}),element.on("mousedown",function(event){event.preventDefault(),startX=event.pageX-x,startY=event.pageY-y,$document.on("mousemove",mousemove),$document.on("mouseup",mouseup)})}}]),angular.module("core").service("Common",function(){var self=this;this.zero=function(num){return num=num<10?"0"+num:num},this.createTimeList=function(arr){for(var i=0,start=":00:00",end=":59:59";i<24;){var num=self.zero(i);arr.push({start:num+start,end:num+end}),i++}},this.dateFormat=function(date){var dateStr=date.getFullYear()+"-"+self.zero(date.getMonth()+1)+"-"+self.zero(date.getDate())+" "+self.zero(date.getHours())+":"+self.zero(date.getMinutes())+":"+self.zero(date.getSeconds());return dateStr},this.dateFormat1=function(date){var dateStr=date.getFullYear()+"-"+self.zero(date.getMonth()+1)+"-"+self.zero(date.getDate());return dateStr}}),angular.module("core").service("headerService",function($http,$q){var headerService={},basicPath=basePath;return headerService.enterpriseInfoList=function(params){var url_join=basicPath+"rs/co/enterpriseInfoList",delay=$q.defer(),obj=JSON.stringify(params);return $http.post(url_join,obj,{transformRequest:angular.identity}).then(function(data){delay.resolve(data)},function(err){delay.reject(err)}),delay.promise},headerService.currentUserInfo=function(){var delay=$q.defer(),url_join=basicPath+"rs/co/userInfo";return $http.get(url_join,{cache:!0}).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},headerService}),ApplicationConfiguration.registerModule("cooperation"),angular.module("core").config(["$stateProvider","$urlRouterProvider","$locationProvider",function($stateProvider,$urlRouterProvider,$locationProvider){$urlRouterProvider.otherwise("/cooperation"),$stateProvider.state("cooperation",{url:"/cooperation?deptId&ppid&source",templateUrl:"template/cooperation/cooperation.html",controller:"coopreationCtrl",data:{displayName:"cooperation"},params:{deptId:null,ppid:null,status:null,transignal:null,source:null}}).state("newcopper",{url:"/newcopper?typeid",templateUrl:"template/cooperation/newcopper.html",controller:"newcoopreationCtrl",data:{displayName:"newcopper"},params:{typeid:null,typename:null,deptId:null,ppid:null,deptName:null,ppidName:null}}).state("coopdetail",{url:"/coopdetail/?coid&source",templateUrl:"template/cooperation/coop_detail.html",controller:"coopdetailCtrl",data:{displayName:"coopdetail"},params:{deptId:null,ppid:null,coid:null}}).state("editdetail",{url:"/editdetail/?coid",templateUrl:"template/cooperation/coop_editdetail.html",controller:"editdetailCtrl"})}]),angular.module("cooperation").controller("coopdetailCtrl",["$scope","$http","$uibModal","$httpParamSerializer","FileUploader","Cooperation","$state","$stateParams","Manage","$sce","$timeout","Common",function($scope,$http,$uibModal,$httpParamSerializer,FileUploader,Cooperation,$state,$stateParams,Manage,$sce,$timeout,Common){function getAudioProgress(){var currentProgress=BimCo.AudioProgress(currentMp3Id);currentProgress>=100&&(isPlay=!1,BimCo.AudioStop(currentMp3Id),$scope.flag.audioPlaying=!1,$("#open_"+currentUuid).show(),$("#close_"+currentUuid).hide(),$scope.$apply(),clearInterval(refreshID))}function sendCommand(optType,id,uuid){var param='{"optType":'+optType+',"coid":"'+id+'"}';2!=optType&&3!=optType&&5!=optType&&6!=optType||(param='{"optType":'+optType+',"coid":"'+id+'","fileUUID":"'+uuid+'","isPreview":true}'),7==optType&&(param='{"optType":'+optType+',"index":"'+id+'","fileUUID":"'+uuid+'","isPreview":true}'),8==optType&&(param='{"title":'+title+"}"),document.location="http://localhost:8080/bv/?param="+param}function backDetail(){$scope.flag.isPreview&&(BimCo.SignCancel(),BimCo.CancelSubmitAll()),$scope.flag.isPreview&&$scope.flag.isPdfsign&&!$scope.flag.isPdfModify&&Cooperation.checkIn(coid).then(function(data){}),$scope.flag.isPreview=!1,$scope.flag.isPdfsign=!1,$scope.flag.isApprove=!1}console.log("detail",$stateParams);var frombeFlag=!1,currentEditOfficeUuid="",currentSuffix="",currentReact="45,50,1080,720";$scope.link=!1,$scope.speachShow=!1,$scope.device=!1,$scope.allowEdit=!0,$scope.isPreview=!1,$scope.flag={},$scope.bjshow=!0,$scope.tjshow=!0,$scope.tgshow=!0,$scope.jjueshow=!0,$scope.jsshow=!0,$scope.dchushow=!0,$scope.isTypePdf=!0,$scope.showMore=!1,$scope.collapse=!1,(client.system.winMobile||client.system.wii||client.system.ps||client.system.android||client.system.ios||client.system.iphone||client.system.ipod||client.system.ipad||client.system.nokiaN)&&($scope.device=!0),$scope.device?$(".palys").addClass("play-bv"):$(".palys").addClass("play-pc");var coidFrombe="",coid=$stateParams.coid.trim();console.log("coid"+coid);var ppid=0,coTypeVo=0,status="",allRelevants=(Date.parse(new Date),[]),sliceRlevants=[],totalPage=0,pageSize=8,pageSizePc=16,currentShowPage=1;$scope.transcoid=coid,$scope.downloadTotal=0;var detailExport={coopExport:[],coid:""};Cooperation.getCollaboration(coid).then(function(data){function replaceAll(strM,str1,str2){for(var stringList=strM.split(str1),i=0;i<stringList.length-1;i++)stringList[i]+=str2;for(var newstr="",j=0;j<stringList.length;j++)newstr+=stringList[j];return newstr}$scope.collaList=data,data.desc&&($scope.collaList.desc=replaceAll(data.desc,"\n","</br>")),data.comments.length&&angular.forEach(data.comments,function(value,key){value.comment&&($scope.collaList.comments[key].comment=replaceAll(value.comment,"\n","</br>"))}),$scope.device?(allRelevants=data.relevants,totalPage=parseInt((allRelevants.length+pageSize-1)/pageSize),totalPage>1&&(sliceRlevants=data.relevants.slice(0,currentShowPage*pageSize),$scope.collaList.relevants=sliceRlevants,$scope.isRevlentMore=!0,$scope.showMore=!0)):$scope.device||(allRelevants=data.relevants,totalPage=parseInt((allRelevants.length+pageSizePc-1)/pageSizePc),totalPage>1&&(sliceRlevants=data.relevants.slice(0,currentShowPage*pageSizePc),$scope.collaList.relevants=sliceRlevants,$scope.isRevlentMore=!0,$scope.showMore=!0)),data.coTypeVo&&(coTypeVo=data.coTypeVo.type),status=data.status,0!==data.bindType&&data.binds.length&&($scope.link=!0,ppid=data.binds[0].ppid),data.speach&&($scope.speachShow=!0,$scope.speachUrl=data.speach.speechUrl),data.deadline&&3==data.isDeadline&&($scope.deadlineStyle="red"),null==data.deadline&&($scope.collaList.deadline="不限期"),data.isSign==-1&&($scope.flag.noNeedSign=!0),null==data.desc||""==data.desc?$(".mobile-job-descrition,.pc-job-descrition").css("display","none"):$(".mobile-job-descrition,.pc-job-descrition").css("display","block"),0==data.relevants.length?$(".mobile-relate,.pc-relate").css("display","none"):$(".mobile-relate,.pc-relate").css("display","block"),0==data.pictures.length?$(".mobile-photo,.pc-photo").css("display","none"):$(".mobile-photo,.pc-photo").css("display","block"),0==data.docs.length?$(".mobile-means,.pc-means").css("display","none"):$(".mobile-means,.pc-means").css("display","block"),0==data.comments.length?$(".mobile-reply,.pc-reply").css("display","none"):$(".mobile-reply,.pc-reply").css("display","block"),data.isCollaborator&&data.isSign==-1&&($scope.bjshow=!0,$scope.tjshow=!0,$scope.tgshow=!1,$scope.jjueshow=!1,$scope.jsshow=!0,$scope.dchushow=!0),(!data.isCollaborator&&0==data.isSign||!data.isCollaborator&&1==data.isSign)&&($scope.bjshow=!1,$scope.tjshow=!0,$scope.tgshow=!0,$scope.jjueshow=!0,$scope.jsshow=!1,$scope.dchushow=!0),data.isCollaborator||data.isSign!=-1||($scope.bjshow=!1,$scope.tjshow=!0,$scope.tgshow=!1,$scope.jjueshow=!1,$scope.jsshow=!1,$scope.dchushow=!0);var statusReject=["已结束","未通过","已通过","已拒绝"];statusReject.indexOf(data.status)!=-1&&($scope.allowEdit=!1,$scope.bjshow=!1,$scope.tgshow=!1,$scope.jjueshow=!1,$scope.jsshow=!1,$scope.flag.noNeedSign=!0),1==data.isSign&&($scope.tgshow=!1,$scope.jjueshow=!1),1==data.isSign&&data.isCollaborator&&($scope.jsshow=!1,$scope.bjshow=!1);var typeArr=["txt","doc","pdf","ppt","docx","xlsx","xls","pptx","jpeg","bmp","PNG","GIF","JPG","png","jpg","gif","dwg","rar","zip","avi","mp4","mov","flv","swf","wmv","mpeg","mpg","mp3"];angular.forEach($scope.collaList.pictures,function(value,key){var imgsrc="imgs/pro-icon/icon-";if(value.name&&value.name.indexOf(".")!==-1){var unit=value.name.split(".")[value.name.split(".").length-1];unit=unit.toLowerCase(),typeArr.indexOf(unit)==-1||null==unit||""==unit||"undefined"==unit?unit="other":"docx"==unit&&(unit="doc"),imgsrc=imgsrc+unit+".png",$scope.collaList.pictures[key].imgsrc=imgsrc}else $scope.collaList.pictures[key].name=value.md5+".png",unit="other",imgsrc=imgsrc+unit+".png",$scope.collaList.pictures[key].imgsrc=imgsrc}),angular.forEach($scope.collaList.docs,function(value,key){var imgsrc="imgs/pro-icon/icon-";if(value.name&&value.name.indexOf(".")!==-1){var unit=value.name.split(".")[value.name.split(".").length-1];unit=unit.toLowerCase(),typeArr.indexOf(unit)==-1||null==unit||""==unit||"undefined"==unit?unit="other":"docx"==unit&&(unit="doc"),imgsrc=imgsrc+unit+".png",$scope.collaList.docs[key].imgsrc=imgsrc}else unit="other",imgsrc=imgsrc+unit+".png",$scope.collaList.docs[key].imgsrc=imgsrc});var commentDocTotal=0;angular.forEach($scope.collaList.comments,function(value,key){commentDocTotal=commentDocTotal+value.docs.length+parseInt(value.speech&&value.speech.uuid?1:0),value.docs&&angular.forEach(value.docs,function(value1,key1){var imgsrc="imgs/pro-icon/icon-",unit=value1.suffix;if(null!=unit&&""!=unit){if(unit=unit.toLowerCase(),typeArr.indexOf(unit)==-1||null==unit||""==unit||"undefined"==unit?($scope.collaList.comments[key].docs[key1].suffix="other",imgsrc+="other.png",$scope.collaList.comments[key].docs[key1].imgsrc=imgsrc):"docx"==unit?(imgsrc+="doc.png",$scope.collaList.comments[key].docs[key1].imgsrc=imgsrc):(imgsrc=imgsrc+unit+".png",$scope.collaList.comments[key].docs[key1].imgsrc=imgsrc),value1.thumbnailUrl&&($scope.collaList.comments[key].docs[key1].imgsrc=value1.thumbnailUrl),null==value1.name&&!$scope.device){(new Date).getTime();$scope.collaList.comments[key].docs[key1].name=value1.md5+".png"}}else $scope.collaList.comments[key].docs[key1].suffix="other",imgsrc+="other.png",$scope.collaList.comments[key].docs[key1].imgsrc=imgsrc})}),$scope.link&&!$scope.speachShow?$(".mobile-devices .paly-model").css({width:"100%"}):!$scope.link&&$scope.speachShow&&$(".mobile-devices .play-audio").css({width:"100%"}),data.speach&&data.speach.uuid?$scope.downloadTotal=data.pictures.length+data.docs.length+commentDocTotal+1:$scope.downloadTotal=data.pictures.length+data.docs.length+commentDocTotal,console.log($scope.downloadTotal);var currentDeadline,picTypeArr=["jpeg","bmp","PNG","GIF","JPG","png","jpg","gif","dwg","rar","zip"],coopExportTemp={firstTitle:"",secondTitle:[]},defaultTitle={firstTitle:"协作主题：",secondTitle:"1.协作信息",threeTitle:"2.更新内容及资料"},secondTitleTemp={title:"",info:[]},infoTemp={coopMsg:[],docs:[]};coopExportTemp.firstTitle=defaultTitle.firstTitle+data.coTypeVo.name+" "+data.name,secondTitleTemp.title=defaultTitle.secondTitle,currentDeadline=data.deadline&&"不限期"!=data.deadline?Common.dateFormat(new Date(data.deadline)).split(" ")[0]:"不限期",data.desc||(data.desc="");var msgArrTemp=[],nameArrTemp=["协作类型：","负责人：","优先级：","限期：","状态：","标识：","描述：","创建人：","创建时间："];msgArrTemp.push(data.coTypeVo.name),msgArrTemp.push(data.collaborator),msgArrTemp.push(data.priority),msgArrTemp.push(currentDeadline),msgArrTemp.push(data.status),msgArrTemp.push(data.markerInfo.name),msgArrTemp.push(data.desc),msgArrTemp.push(data.creator),msgArrTemp.push(data.createTime.split(" ")[0]);for(var i=0;i<nameArrTemp.length;i++){var coopMsgTemp={};("描述："!==nameArrTemp[i]||data.desc)&&(coopMsgTemp={name:nameArrTemp[i],msg:msgArrTemp[i],isFirstLine:!1},infoTemp.coopMsg.push(coopMsgTemp))}angular.forEach(data.pictures,function(value,key){var temp={};value.name&&value.name.indexOf(".")!==-1?temp.fileName=value.name:temp.fileName=value.md5+".png",temp.uuid=value.uuid?value.uuid:"",temp.type=1,infoTemp.docs.push(temp)});var docSort=[];if(angular.forEach(data.docs,function(value,key){if(value.name&&value.name.indexOf(".")!==-1){var unit=value.name.split(".")[value.name.split(".").length-1];picTypeArr.indexOf(unit)!==-1&&docSort.push(value)}}),angular.forEach(data.docs,function(value,key){if(value.name&&value.name.indexOf(".")!==-1){var unit=value.name.split(".")[value.name.split(".").length-1];picTypeArr.indexOf(unit)==-1&&docSort.push(value)}}),angular.forEach(data.docs,function(value,key){value.name&&value.name.indexOf(".")==-1&&docSort.push(value)}),angular.forEach(docSort,function(value,key){var temp={};temp.uuid=value.uuid,temp.fileName=value.name,temp.type=2,infoTemp.docs.push(temp)}),data.speach&&data.speach.uuid){var temp={};temp.uuid=data.speach.uuid,temp.fileName=data.speach.md5+".mp3",temp.type=2,infoTemp.docs.push(temp)}secondTitleTemp.info.push(infoTemp),coopExportTemp.secondTitle.push(secondTitleTemp);secondTitleTemp={title:"",info:[]},angular.forEach(data.comments,function(value,key){var commentDoc=[],tempTitle="2."+(key+1);secondTitleTemp.title=defaultTitle.threeTitle,infoTemp={coopMsg:[],docs:[]};var commentNameArrTemp=["添加人：","添加时间：","描述："],commentMsgArrTemp=[];value.status&&(commentNameArrTemp=["状态：","添加人：","添加时间：","描述："],commentMsgArrTemp.push(value.status)),commentMsgArrTemp.push(value.commentator),commentMsgArrTemp.push(Common.dateFormat(new Date(value.commentTime))),commentMsgArrTemp.push(value.comment);for(var i=0;i<commentNameArrTemp.length;i++){var coopMsgTemp={};0===i?(coopMsgTemp={name:tempTitle+commentNameArrTemp[i],msg:commentMsgArrTemp[i],isFirstLine:!0},infoTemp.coopMsg.push(coopMsgTemp)):(coopMsgTemp={name:commentNameArrTemp[i],msg:commentMsgArrTemp[i],isFirstLine:!1},infoTemp.coopMsg.push(coopMsgTemp))}if(value.docs&&(angular.forEach(value.docs,function(value1,key1){picTypeArr.indexOf(value1.suffix)!==-1&&commentDoc.push(value1)}),angular.forEach(value.docs,function(value3,key3){picTypeArr.indexOf(value3.suffix)!=-1&&value3.suffix||commentDoc.push(value3)}),angular.forEach(commentDoc,function(value2,key2){var temp={};temp.fileName=value2.name,temp.uuid=value2.uuid,temp.type=3,infoTemp.docs.push(temp)})),value.speech&&value.speech.uuid){var temp={};temp.fileName=value.speech.md5+".mp3",temp.uuid=value.speech.uuid,temp.type=3,infoTemp.docs.push(temp)}secondTitleTemp.info.push(infoTemp)}),coopExportTemp.secondTitle.push(secondTitleTemp),detailExport.coopExport.push(coopExportTemp),detailExport.coid=coid,console.log(detailExport),$scope.loadComplete=!0}),$scope.doExport=function(){function setRefreshInterval(){exportRefreshID=setInterval(refreshState,1e3)}function refreshState(){var reCode=BimCo.IsShowProgressBar();reCode?($(".downloading").css("display","block"),$(".down-mark").css("display","block"),$(".downloadIndex").css("display","block"),$("html").css("overflow-y","hidden")):reCode||(clearInterval(exportRefreshID),$(".downloading").css("display","none"),$(".down-mark").css("display","none"),$(".downloadIndex").css("display","none"),$("html").css("overflow-y",""))}console.log($scope.downloadTotal+"downloadTotal");var exportRefreshID,strExportInfo=JSON.stringify(detailExport);console.log(strExportInfo);var strCoName=$scope.collaList.coTypeVo.name+" "+$scope.collaList.name;BimCo.ExportCooperation(strExportInfo,strCoName),setRefreshInterval()};var id="#jquery_jplayer_1",flashHtml="";$scope.device,flashHtml="html,flash";var bubble={title:"Bubble",mp3:""},options={solution:flashHtml,swfPath:"./lib/audio1",supplied:"mp3",wmode:"window",useStateClassSkin:!0,autoBlur:!1,smoothPlayBar:!0,keyEnabled:!0,remainingDuration:!0,preload:"auto",ended:function(){$(".detail-voice").hide()}},myAndroidFix=new jPlayerAndroidFix(id,bubble,options),oldSpeechUrl=null;$scope.play=function(speechUrl){var datamp3url;$(".detail-voice").css("display","block"),$(".detail-close").css("display","block"),oldSpeechUrl!=speechUrl?($.ajax({type:"POST",url:basePath+"rs/co/getMP3URL",data:speechUrl,async:!1,contentType:"text/HTML",success:function(mp3url,status,XMLHttpRequest){mp3url.indexOf("<!DOCTYPE html>")!=-1&&(document.location="co_detail.jsp?coid="+coid),datamp3url=mp3url}}),bubble.mp3=datamp3url,oldSpeechUrl=speechUrl,myAndroidFix.setMedia(bubble).play()):myAndroidFix.play()};var currentMp3Id,currentUuid,refreshID,isPlay=!1;$scope.getPcMP3Url=function(uuid,source){var uuidList=[uuid];"comment"==source?isPlay?(console.log("当前正在播放录音,不处理"),layer.alert("当前正在播放录音！",{title:"提示",closeBtn:0,move:!1})):(isPlay=!0,currentUuid=uuid,$("#open_"+uuid).hide(),$("#close_"+uuid).show(),Cooperation.getPcMp3Url(uuidList).then(function(data){angular.forEach(data,function(value,key){refreshID=setInterval(getAudioProgress,1e3),console.info(currentMp3Id),currentMp3Id=BimCo.AudioPlay(value)})})):isPlay?layer.alert("当前正在播放录音！",{title:"提示",closeBtn:0,move:!1}):(isPlay=!0,currentUuid=uuid,Cooperation.getPcMp3Url(uuidList).then(function(data){angular.forEach(data,function(value,key){""==source?($scope.flag.audioPlaying=!0,refreshID=setInterval(getAudioProgress,1e3)):($scope.flag.commentAudioPlaying=!0,refreshID=setInterval(getAudioProgress,1e3)),currentMp3Id=BimCo.AudioPlay(value)})}))},$scope.AudioStop=function(source,uuid){isPlay=!1,currentUuid=null,""==source?$scope.flag.audioPlaying=!1:($("#open_"+uuid).show(),$("#close_"+uuid).hide()),clearInterval(refreshID)},$scope.audioClose=function(){$("#jquery_jplayer_1").jPlayer("stop"),$(".detail-voice").hide(),$(".detail-close").hide()},$scope.allowEditTrans=function(){var checkCoLocked=!1;$.ajax({type:"POST",url:basePath+"rs/co/checkCoLocked/"+coid,async:!1,contentType:"text/HTML",success:function(data,status,XMLHttpRequest){data&&(checkCoLocked=!0,layer.alert("当前协作已被“"+data+"”签出，请稍后重试！",{title:"提示",closeBtn:0,move:!1},function(index){layer.close(index)}))},error:function(XMLHttpRequest,textStatus,errorThrown){layer.alert(textStatus,{title:"提示",closeBtn:0,move:!1},function(index){layer.close(index)})}}),checkCoLocked||($scope.allowEdit?(Cooperation.checkOut(coid).then(function(data){}),
$state.go("editdetail",{coid:coid})):layer.alert("当前协作已被“"+$scope.collaList.operationName+"”签出，请稍后重试！",{title:"提示",closeBtn:0,move:!1}))},$scope.checkModelpc=function(){"block"==$(".detail-voice").css("display")&&$scope.audioClose(),BimCo.LocateComponent(ppid,coid)},$scope.checkModel=function(){"block"==$(".detail-voice").css("display")&&$scope.audioClose(),sendCommand(1,coid)},$scope.zoom=function(uuid){sendCommand(6,coid,uuid)},$scope.previewComment=function(index,uuid){sendCommand(7,index,uuid)},$scope.docsOpen=function(uuid){sendCommand(5,coid,uuid)},$scope.previewDocs=function(uuid){sendCommand(2,coid,uuid)},$scope.downDocs=function(uuid){sendCommand(3,coid,uuid)};var searchFlag,checkSearchInterval,trendflag=!0,pollingFlag=!0;$scope.scrollend=!1,$scope.addMoreData=function(){token&&(setSearchFlagFalse(),pollingFlag&&(pollingFlag=!1,checkSearchInterval=setInterval(function(){checkCanSearch()},100)),setTimeout(function(){setSearchFlagTrue()},150))};var setSearchFlagFalse=function(){searchFlag=!1},setSearchFlagTrue=function(){searchFlag=!0},checkCanSearch=function(){searchFlag&&(clearInterval(checkSearchInterval),$scope.getOperation(),pollingFlag=!0)};$scope.getOperation=function(){var size=$scope.operationList.length;if(size%dynamicPageSize!=0||size==$scope.operationAllList.length)return void($scope.scrollend=!0);for(var l=size/dynamicPageSize,result=$scope.operationAllList.slice(dynamicPageSize*l,(l+1)*dynamicPageSize),i=0;i<result.length;i++)$scope.operationList.push(result[i]);$scope.$apply()},$scope.operationAllList=[];var dynamicPageSize=10,dynamicCurrentShowPage=1,token=!1;$scope.getOperationList=function(){trendflag&&($scope.scrollend=!1,Cooperation.getOperationList(coid).then(function(data){$scope.operationAllList=data,$scope.operationList=data.slice(0,dynamicCurrentShowPage*dynamicPageSize);var size=$scope.operationList.length;size%dynamicPageSize==0&&size!=$scope.operationAllList.length||($scope.scrollend=!0),token=!0})),trendflag=!1};var modalInstance;$scope.updateComment=function(){var trans={};trans.coid=coid,trans.coTypeVo=coTypeVo,trans.status=status,modalInstance=$uibModal.open({windowClass:"update-comment",size:"lg",backdrop:"static",templateUrl:"template/cooperation/updatecomment.html",controller:"updatecommentCtrl",resolve:{items:function(){return trans}}}),modalInstance.result.then(function(data){Cooperation.commentToCollaboration(data).then(function(data){$state.go($state.current,{},{reload:!0})},function(data){layer.alert(data.message,{title:"提示",closeBtn:0,move:!1})})})},$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){$(".action .picInfo .data-list .deta-down ").hover(function(){$(this).find(".show-icon").stop().animate({bottom:"-1px"})},function(){$(this).find(".show-icon").stop().animate({bottom:"-38px"})}),$(".detail-sear").hover(function(){$(this).find(".detail-search").stop().animate({bottom:"-1px"})},function(){$(this).find(".detail-search").stop().animate({bottom:"-38px"})}),$(".replay-down").hover(function(){$(this).find(".user-down").animate({bottom:"0"})},function(){$(this).find(".user-down").animate({bottom:"-30px"})}),$scope.device&&$timeout(function(){$(".scrollLoading").scrollLoading()},0)}),$scope.doCollaboration=function(statusCode){function doCollaboration(){Cooperation.doCollaboration(params).then(function(data){layer.closeAll(),$state.go($state.current,{},{reload:!0})},function(data){layer.closeAll(),layer.alert(data.message,{title:"提示",closeBtn:0,move:!1})})}var params={coid:coid,docs:[],operationType:statusCode},checkCoLocked=!1;if($.ajax({type:"POST",url:basePath+"rs/co/checkCoLocked/"+coid,async:!1,contentType:"text/HTML",success:function(data,status,XMLHttpRequest){data&&(checkCoLocked=!0,layer.alert("当前协作已被“"+data+"”签出，请稍后重试！",{title:"提示",closeBtn:0,move:!1},function(index){layer.close(index)}))},error:function(XMLHttpRequest,textStatus,errorThrown){layer.alert(textStatus,{title:"提示",closeBtn:0,move:!1},function(index){layer.close(index)})}}),!checkCoLocked)switch(statusCode){case 6:layer.confirm("提交后您将不能再修改，若确认通过，请点击确定!",{btn:["确定","取消"],move:!1},function(){doCollaboration()});break;case 7:layer.confirm("提交后您将不能再修改，若确认拒绝，请点击确定！",{btn:["确定","取消"],move:!1},function(){doCollaboration()});break;case 8:layer.confirm("提交后您将不能再修改，若确认结束，请点击确定！",{btn:["确定","取消"],move:!1},function(){doCollaboration()});break;default:doCollaboration()}},$scope.previewSign=function(uuid,docName,isPdfsign){var suffix="";if(suffix=docName&&docName.indexOf(".")!=-1?docName.split(".")[docName.split(".").length-1]:"","pdf"==suffix&&1==isPdfsign){var createindex;$timeout(function(){createindex=layer.load(1,{shade:[.5,"#000"]})},10),$timeout(function(){var pdfSign=BimCo.PdfSign(uuid,suffix,currentReact,coid);return pdfSign?(layer.close(createindex),$scope.flag.isPreview=!0,$scope.flag.isApprove=!0,$scope.flag.isGeneral=!1,$scope.flag.isPdfsign=!1,void 0):void layer.close(createindex)},500)}else{var data={fileName:docName,uuid:uuid};Manage.getTrendsFileViewUrl(data).then(function(result){$scope.flag.isPreview=!0,$scope.flag.isGeneral=!0,$scope.flag.isPdfsign=!1,$scope.flag.isApprove=!1,$scope.previewUrl=$sce.trustAsResourceUrl(result)},function(data){$scope.flag.isPreview=!1,$scope.previewUrl="";var obj=JSON.parse(data);layer.alert(obj.message,{title:"提示",closeBtn:0,move:!1})})}},$scope.addApprove=function(){return 1==$scope.collaList.isSign?void BimCo.MessageBox("提示","您已通过（拒绝）该协作，不能进行二次审批！",0):"已结束"==$scope.collaList.status?void BimCo.MessageBox("提示","当前协作已结束，不能再进行操作!",0):void Cooperation.checkOut(coid).then(function(data){$scope.flag.isPdfsign=!0,$scope.flag.isApprove=!1},function(data){BimCo.MessageBox("提示",data.message,0)})},$scope.signComment=function(){$scope.isSign=!0,BimCo.CommentSign(currentEditOfficeUuid,currentSuffix)},$scope.signElectronic=function(){var signature;$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"get",url:basePath+"rs/co/signature",async:!1,success:function(data){signature=data.uuid,$scope.isEleSign=!0},error:function(){}}),BimCo.ElectronicSign(signature)},$scope.SubmitAll=function(){if(!BimCo.IsModify())return $scope.flag.isPdfModify=!1,void $scope.backDetail("submit");$scope.flag.isPdfModify=!0;var backJson,rtn=BimCo.MessageBox("提示","提交后将不能再修改，若确认无误请点击确认！",49),modifyDocs=[];if(1==rtn){BimCo.SignSubmit(),backJson=BimCo.SubmitAll(),backJson&&(backJson=JSON.parse(backJson)),backJson&&angular.forEach(backJson,function(value,key){if(value){var unit={};unit.uuid=key,unit.modifys=value.PdfModify,modifyDocs.push(unit)}});var params={coid:coid,docs:modifyDocs,operationType:4};Cooperation.doCollaboration(params).then(function(data){$scope.flag.isPreview=!1},function(data){Cooperation.checkIn(coid).then(function(data){}),$scope.flag.isPreview=!1,BimCo.MessageBox("提示",data.message,0)})}},$scope.signCancel=function(){if(!BimCo.IsModify())return $scope.flag.isPdfModify=!1,void $scope.backDetail("cancel");$scope.flag.isPdfModify=!0;var rtn=BimCo.MessageBox("提示","          放弃编辑？",49);1==rtn&&(Cooperation.checkIn(coid).then(function(data){}),BimCo.SignCancel(),BimCo.CancelSubmitAll(),$scope.flag.isPreview=!1)},$scope.signEmpty=function(){BimCo.SignEmpty()},$scope.minimize=function(){BimCo.SysCommand("SC_MINIMIZE")},$scope.max=!0,$scope.maxRestore=function($event){BimCo.SysCommand("SC_MAXIMIZE")},$scope.close=function(){BimCo.SysCommand("SC_CLOSE")},$scope.showMorePerson=function(){currentShowPage++,currentShowPage>=2&&($scope.collapse=!0),$scope.collaList.relevants=allRelevants.slice(0,currentShowPage*pageSize),$scope.device||($scope.collaList.relevants=allRelevants.slice(0,currentShowPage*pageSizePc)),currentShowPage>=totalPage&&($scope.showMore=!1)},$scope.collapsePerson=function(){$scope.collaList.relevants=sliceRlevants,$scope.showMore=!0,$scope.collapse=!1,currentShowPage=1},$scope.backDetail=function(source){if(""==source){if(!BimCo.IsModify())return $scope.flag.isPdfModify=!1,void backDetail();$scope.flag.isPdfModify=!0;var rtn=BimCo.MessageBox("提示","          放弃编辑？",49);1==rtn&&(Cooperation.checkIn(coid).then(function(data){}),BimCo.SignCancel(),BimCo.CancelSubmitAll(),$scope.flag.isPreview=!1)}else backDetail()},$scope.backCooperation=function(){"草稿箱"==$scope.collaList.status?$scope.collaList.deptId=0:$scope.collaList.deptId||$scope.collaList.ppid||"草稿箱"==$scope.collaList.status||($scope.collaList.deptId=-1);var rember=$stateParams.source||frombeFlag?"":"rember";$state.go("cooperation",{deptId:$scope.collaList.deptId,ppid:$scope.collaList.ppid,status:$scope.collaList.statusId,source:rember},{location:"replace"})};$scope.checkFromBe=function(){if(frombeFlag=!0,coidFrombe=$("#checkformbe").val(),$scope.flag.isPdfsign){var rtn=BimCo.MessageBox("提示","当前正在签署中，是否跳转？",49);1==rtn&&(BimCo.SignCancel(),BimCo.CancelSubmitAll(),$state.go("coopdetail",{coid:coidFrombe},{reload:!0}),Cooperation.checkIn(coid).then(function(data){}))}else if($scope.flag.isApprove&&!$scope.flag.isPdfsign){var rtn=BimCo.MessageBox("提示","当前正在签署中，是否跳转？",49);1==rtn&&(BimCo.SignCancel(),BimCo.CancelSubmitAll(),$state.go("coopdetail",{coid:coidFrombe},{reload:!0}))}else coidFrombe!=coid?layer.confirm("当前已有打开的协作, 是否跳转？",{btn:["确定","取消"],move:!1},function(){layer.closeAll(),$state.go("coopdetail",{coid:coidFrombe})}):modalInstance?layer.confirm("当前正在添加更新, 是否跳转？",{btn:["确定","取消"],move:!1},function(){layer.closeAll(),$state.go("coopdetail",{coid:coidFrombe},{reload:!0})}):coidFrombe!=coid||$scope.flag.isApprove||modalInstance||$state.go("coopdetail",{coid:coidFrombe},{reload:!0})},$scope.device||Cooperation.heartBeat(),$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){clearInterval(ApplicationConfiguration.refreshID),modalInstance&&modalInstance.dismiss()})}]),angular.module("cooperation").controller("editdetailCtrl",["$scope","$http","$uibModal","$httpParamSerializer","FileUploader","Cooperation","$state","$stateParams","Common","Manage","$timeout","headerService","$sce",function($scope,$http,$uibModal,$httpParamSerializer,FileUploader,Cooperation,$state,$stateParams,Common,Manage,$timeout,headerService,$sce){function replaceAll(strM,str1,str2){for(var stringList=strM.split(str1),i=0;i<stringList.length-1;i++)stringList[i]+=str2;for(var newstr="",j=0;j<stringList.length;j++)newstr+=stringList[j];return newstr}function sendCommand(optType,id,uuid){var param='{"optType":'+optType+',"coid":"'+id+'"}';2!=optType&&3!=optType&&5!=optType&&6!=optType||(param='{"optType":'+optType+',"coid":"'+id+'","fileUUID":"'+uuid+'","isPreview":true}'),document.location="http://localhost:8080/bv/?param="+param}$scope.device=!1,$scope.flag={},(client.system.winMobile||client.system.wii||client.system.ps||client.system.android||client.system.ios||client.system.iphone||client.system.ipod||client.system.ipad||client.system.nokiaN)&&($scope.device=!0),client.system.android&&client.system.android<4.3&&($scope.flag.adroidLs4=!0),$scope.showMore=!1,$scope.collapse=!1;var coid=$stateParams.coid;$scope.transcoid=$stateParams.coid,$scope.zhenggai=!1,$scope.responsiblePerson={};var contracts=[];$scope.dateOptions={formatYear:"yy",maxDate:new Date(2020,5,22),startingDay:1,showWeeks:!1,minDate:new Date,yearRows:3,yearColumns:3},$scope.open2=function(){$scope.popup2.opened=!0,$scope.isDeadlineNull=!1},$scope.popup2={opened:!1},$scope.checksignal=!1;var coid=$stateParams.coid,allRelevants=[],sliceRlevants=[],pcAllRelevants=[];$scope.related={sign:[],noSign:[]};var totalPage=0,pageSize=8,pageSizePc=18,currentShowPage=1,relatedNews=[];Cooperation.getCollaboration(coid).then(function(data){angular.forEach(data.relevants,function(value,key){value.mustExist=!0,value.canSign=!0,value.needSign?$scope.related.sign.push(value):$scope.related.noSign.push(value)}),relatedNews=$scope.related.sign.concat($scope.related.noSign),$scope.relatedNew=relatedNews;var currentMarkInfo=data.markerInfo.id;if($scope.collaList=data,$scope.priority=data.priority,$scope.device?(allRelevants=_.cloneDeep(data.relevants),totalPage=parseInt((allRelevants.length+pageSize-1)/pageSize),totalPage>1&&(sliceRlevants=_.cloneDeep(data.relevants.slice(0,currentShowPage*pageSize)),$scope.collaList.relevants=sliceRlevants,$scope.isRevlentMore=!0,$scope.showMore=!0),angular.forEach(allRelevants,function(value,key){var unit={};unit.username=value.username,unit.needSign=value.needSign,contracts.push(unit)})):$scope.device||(pcAllRelevants=data.relevants,totalPage=parseInt((relatedNews.length+pageSizePc-1)/pageSizePc),totalPage>1&&(sliceRlevants=relatedNews.slice(0,currentShowPage*pageSizePc),$scope.relatedNew=sliceRlevants,$scope.isRevlentMore=!0,$scope.showMore=!0),angular.forEach(pcAllRelevants,function(value,key){var unit={};unit.username=value.username,unit.needSign=value.needSign,contracts.push(unit)})),"I"==data.priority?$scope.priority="1":"II"==data.priority?$scope.priority="2":"III"==data.priority&&($scope.priority="3"),$scope.dt=data.deadline,$scope.desc=data.desc,data.deadline||($scope.isDeadlineNull=!0),data.deadline&&3==data.isDeadline&&($scope.deadlineStyle="red"),data.comments.length&&angular.forEach(data.comments,function(value,key){value.comment&&($scope.collaList.comments[key].comment=replaceAll(value.comment,"\n","</br>"))}),data){Cooperation.getMarkerList().then(function(data){$scope.markerList1=data,$scope.mark1=currentMarkInfo+"",data[0].markerId&&$timeout(function(){$(".selectpicker1").selectpicker({style:"",size:"auto"})},0)}),Cooperation.getPriorityList().then(function(data){$scope.priorityList=data,data[0].code&&$timeout(function(){$(".selectpicker").selectpicker({style:"",size:"auto"})},0)});var isShowArr=["已结束","已通过","已拒绝"];1===data.coTypeVo.type&&isShowArr.indexOf($scope.status)==-1&&($scope.zhenggai=!0,$(".detail-state").show())}0==$scope.collaList.relevants.length?$(".mobile-relate,.pc-relate").css("display","none"):$(".mobile-relate,.pc-relate").css("display","block"),0==$scope.collaList.pictures.length?$(".mobile-photo,.pc-photo").css("display","none"):$(".mobile-photo,.pc-photo").css("display","block"),0==$scope.collaList.docs.length?$(".mobile-means,.pc-means").css("display","none"):$(".mobile-means,.pc-means").css("display","block"),0==$scope.collaList.comments.length?$(".mobile-reply,.pc-reply").css("display","none"):$(".mobile-reply,.pc-reply").css("display","block"),$scope.selectResponsible=function(){var modalInstance=$uibModal.open({backdrop:"static",templateUrl:"template/cooperation/select_person_responsible.html",controller:"selectpersonCtrl",resolve:{items:function(){return[]}}});modalInstance.result.then(function(selectedItem){$scope.responsiblePerson=selectedItem})},headerService.currentUserInfo().then(function(data){$scope.responsiblePerson.username=data.userName,$scope.responsiblePerson.avatar=data.avatarUrl});var typeArr=["txt","doc","pdf","ppt","docx","xlsx","xls","pptx","jpeg","bmp","PNG","GIF","JPG","png","jpg","gif","dwg","rar","zip","avi","mp4","mov","flv","swf","wmv","mpeg","mpg","mp3"];angular.forEach($scope.collaList.pictures,function(value,key){var imgsrc="imgs/pro-icon/icon-";if(value.name&&value.name.indexOf(".")!==-1){var unit=value.name.split(".")[value.name.split(".").length-1];unit=unit.toLowerCase(),typeArr.indexOf(unit)==-1||null==unit||""==unit||"undefined"==unit?unit="other":"docx"==unit&&(unit="doc"),imgsrc=imgsrc+unit+".png",$scope.collaList.pictures[key].imgsrc=imgsrc}else $scope.collaList.pictures[key].name=value.md5+".png",unit="other",imgsrc=imgsrc+unit+".png",$scope.collaList.pictures[key].imgsrc=imgsrc}),angular.forEach($scope.collaList.docs,function(value,key){var imgsrc="imgs/pro-icon/icon-";if(value.name.indexOf(".")!==-1){var unit=value.name.split(".")[value.name.split(".").length-1];unit=unit.toLowerCase(),typeArr.indexOf(unit)==-1||null==unit||""==unit||"undefined"==unit?unit="other":"docx"==unit&&(unit="doc"),imgsrc=imgsrc+unit+".png",$scope.collaList.docs[key].imgsrc=imgsrc}else unit="other",imgsrc=imgsrc+unit+".png",$scope.collaList.docs[key].imgsrc=imgsrc}),angular.forEach($scope.collaList.comments,function(value,key){value.docs&&angular.forEach(value.docs,function(value1,key1){var imgsrc="imgs/pro-icon/icon-",unit=value1.suffix;if(unit=unit.toLowerCase(),typeArr.indexOf(unit)==-1||null==unit||""==unit||"undefined"==unit?($scope.collaList.comments[key].docs[key1].suffix="other",imgsrc+="other.png",$scope.collaList.comments[key].docs[key1].imgsrc=imgsrc):"docx"==unit?(imgsrc+="doc.png",$scope.collaList.comments[key].docs[key1].imgsrc=imgsrc):(imgsrc=imgsrc+unit+".png",$scope.collaList.comments[key].docs[key1].imgsrc=imgsrc),value1.thumbnailUrl&&($scope.collaList.comments[key].docs[key1].imgsrc=value1.thumbnailUrl),null==value1.name&&!$scope.device){(new Date).getTime();$scope.collaList.comments[key].docs[key1].name=value1.md5+".png"}})})}),$scope.switchMark=function(mark1){$scope.mark1=mark1},$scope.switchPriority=function(priority){$scope.priority=priority},$scope.checkModel=function(){sendCommand(1,coid)},$scope.zoom=function(uuid){sendCommand(6,coid,uuid)},$scope.docsOpen=function(uuid){sendCommand(5,coid,uuid)},$scope.previewDocs=function(uuid){sendCommand(2,coid,uuid)},$scope.downDocs=function(uuid){sendCommand(3,coid,uuid)},$scope.ok=function(){if(!$scope.collaList.name&&$scope.device){layer.open({type:1,title:!1,closeBtn:0,shadeClose:!0,skin:"yourclass",move:!1,content:'<div class="tips">当前协作主题不能为空</div><div class="tips_ok" onclick="layer.closeAll();">好</div>'})}if(!$scope.collaList.name&&!$scope.device)return void($scope.flag.topicNull=!0);if(!$scope.device&&$scope.collaList.name)var createindex=layer.load(1,{shade:[.5,"#000"]});$scope.device?$scope.dt=$(".date-value-bv").html():$scope.dt=$(".date-value").html(),$scope.dt?$scope.dt=$scope.dt:$scope.dt="";var data={coid:coid,contracts:contracts,deadline:$scope.dt,desc:$scope.collaList.desc,markerid:parseInt($scope.mark1),name:$scope.collaList.name,priority:$scope.priority,status:$scope.collaList.statusId};Cooperation.updateCollaboration(data).then(function(data,status){if($scope.device){if(data.indexOf("<!DOCTYPE html>")!=-1)var param='{"optType":9,"isSuccess":false}';else var param='{"optType":9,"isSuccess":true}';document.location="http://localhost:8080/bv/?param="+param}else layer.close(createindex),document.location="co_detail.jsp?coid="+coid},function(data){if($scope.device){var param;param=data&&data.message?'{"optType":9,"isSuccess":false,"message":"'+data.message+'"}':'{"optType":9,"isSuccess":false}',document.location="http://localhost:8080/bv/?param="+param}else layer.close(createindex),layer.alert(data.message,{title:"提示",closeBtn:0,move:!1})})},$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){$(".action .picInfo .data-list .deta-down ").hover(function(){$(this).find(".show-icon").stop().animate({bottom:"-1px"})},function(){$(this).find(".show-icon").stop().animate({bottom:"-38px"})}),$(".detail-sear").hover(function(){$(this).find(".detail-search").stop().animate({bottom:"-1px"})},function(){$(this).find(".detail-search").stop().animate({bottom:"-38px"})}),$(".replay-down").hover(function(){$(this).find(".user-down").animate({bottom:"0"})},function(){$(this).find(".user-down").animate({bottom:"-30px"})}),$scope.device&&$timeout(function(){$(".scrollLoading").scrollLoading()},0)}),$scope.selectRelated=function(){var modalInstance=$uibModal.open({windowClass:"edit-related",size:"lg",backdrop:"static",animation:!1,templateUrl:"template/cooperation/select_person_related.html",controller:"selectpersonCtrl",resolve:{items:function(){return $scope.related}}});modalInstance.result.then(function(selectedItem){$scope.related.noSign=selectedItem.noSign,$scope.related.sign=selectedItem.sign,relatedNews=selectedItem.sign.concat(selectedItem.noSign),$scope.relatedNew=relatedNews,currentShowPage=1,$scope.device||(totalPage=parseInt((relatedNews.length+pageSizePc-1)/pageSizePc),totalPage>1&&(sliceRlevants=relatedNews.slice(0,currentShowPage*pageSizePc),$scope.relatedNew=sliceRlevants,$scope.isRevlentMore=!0)),contracts.length&&(contracts=[]),angular.forEach(selectedItem.noSign,function(value,key){var needSign=!1,a={};a.needSign=needSign,a.username=value.username,contracts.push(a)}),angular.forEach(selectedItem.sign,function(value,key){var needSign=!0,a={};a.needSign=needSign,a.username=value.username,contracts.push(a)})})},$scope.onTurn=function(){},$scope.previewSign=function(uuid,docName){var data={fileName:docName,uuid:uuid};Manage.getTrendsFileViewUrl(data).then(function(result){console.log(typeof result),$scope.flag.isPreview=!0,$scope.previewUrl=$sce.trustAsResourceUrl(result)},function(data){$scope.flag.isPreview=!1,$scope.previewUrl="";var obj=JSON.parse(data);layer.alert(obj.message,{title:"提示",closeBtn:0,move:!1})})},$scope.backDetail=function(){Cooperation.checkIn(coid).then(function(data){}),$state.go("coopdetail",{coid:coid})},$scope.minimize=function(){BimCo.SysCommand("SC_MINIMIZE")},$scope.maxRestore=function($event){BimCo.SysCommand("SC_MAXIMIZE")},$scope.close=function(){BimCo.SysCommand("SC_CLOSE")},$scope.showMorePerson=function(){currentShowPage++,currentShowPage>=2&&($scope.collapse=!0),$scope.collaList.relevants=allRelevants.slice(0,currentShowPage*pageSize),$scope.device||($scope.relatedNew=relatedNews.slice(0,currentShowPage*pageSizePc)),currentShowPage>=totalPage&&($scope.showMore=!1)},$scope.collapsePerson=function(){$scope.collaList.relevants=sliceRlevants,$scope.device||($scope.relatedNew=sliceRlevants),$scope.showMore=!0,$scope.collapse=!1,currentShowPage=1};var currentPage="editdetail";$scope.checkFromBe=function(){var coidFrombe=$("#checkformbe").val();"editdetail"==currentPage&&layer.confirm("当前正在编辑协作，是否跳转？",{btn:["确定","取消"],move:!1},function(){layer.closeAll(),$state.go("coopdetail",{coid:coidFrombe})})},$scope.device||Cooperation.heartBeat(),$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){clearInterval(ApplicationConfiguration.refreshID)})}]),angular.module("cooperation").controller("coopreationCtrl",["$scope","$http","$uibModal","$httpParamSerializer","FileUploader","Cooperation","$state","$stateParams","$location","$timeout",function($scope,$http,$uibModal,$httpParamSerializer,FileUploader,Cooperation,$state,$stateParams,$location,$timeout){function getimgurl(treeItems,deptId){$("#dept_"+deptId).empty();for(var i=0;i<treeItems.length;i++)"土建预算"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/1.png":"钢筋预算"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/2.png":"安装预算"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/3.png":"Revit"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/4.png":"Tekla"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/5.png":"PDF"==treeItems[i].projectType&&(treeItems[i].imgsrc="imgs/icon/6.png"),treeItems[i].count?$("#dept_"+deptId).append("<span id=projectbutton_"+treeItems[i].ppid+" title='"+treeItems[i].projectName+"' class='spanwidth'><img src='"+treeItems[i].imgsrc+"'><span class='substr-sideMenus coop-menusSet' style='display:inline-block;'>"+treeItems[i].projectName+"</span>&nbsp;<b class='coop-countElement'>("+treeItems[i].count+")</b></span>"):$("#dept_"+deptId).append("<span id=projectbutton_"+treeItems[i].ppid+" title='"+treeItems[i].projectName+"' class='spanwidth'><img src='"+treeItems[i].imgsrc+"'><span class='substr-sideMenus coop-menusSet' style='display:inline-block;'>"+treeItems[i].projectName+"</span></span>");$("span[id^='projectbutton_']").bind("click",function(){var createindex=layer.load(1,{shade:[.5,"#000"]});$scope.searchkey=$("#exampleInputName1").val(),queryData.searchKey=$scope.searchkey,$scope.flag.isDraft=!1,$(".manage-menus").removeClass("menusActive"),$("span[class*=ng-binding]").removeClass("menusActive"),$(this).addClass("menusActive").siblings().removeClass("menusActive"),$(" .data_count").hide(),$(".table-list.basic-project").show(),0!=queryData.groups.length?$scope.getCollaborationList($(this).attr("id").split("_")[1],$(this).find(".substr-sideMenus").text()):($scope.cooperationList=[],$scope.coNoResult=!0,$scope.searchNoCo=!0),setTimeout(function(){layer.close(createindex)},200)})}function isCheck(){$(".icon-sub").attr("src","imgs/icon/funnel.png")}function isNotCheck(){$(".icon-sub").attr("src","imgs/icon/funnel-1.png")}function assemblyGroups(type,priority,mark){var result=[];return angular.forEach(type,function(value,key){var unit={};unit.type=601,unit.value={key:value.key},result.push(unit)}),angular.forEach(priority,function(value,key){var unit={};unit.type=602,unit.value={key:value.key},result.push(unit)}),angular.forEach(mark,function(value,key){var unit={};unit.type=603,unit.value={key:value.key},result.push(unit)}),result}function addSessionValue(){if(!_.isEqual(queryTypeSelected,$scope.coQueryType)||!_.isEqual(queryPriorityselected,$scope.coPriority)||!_.isEqual(queryMarkSelected,$scope.coMark))if(oldSelsectType=new Array($scope.coQueryType.length),oldPriority=new Array($scope.coPriority.length),oldMark=new Array($scope.coMark.length),queryTypeSelected.length)for(var i=0;i<$scope.coQueryType.length;i++)for(var originName=$scope.coQueryType[i].name,j=0;j<queryTypeSelected.length;j++){if(originName===queryTypeSelected[j].name){oldSelsectType[i]={name:originName,flag:!0};break}oldSelsectType[i]={name:$scope.coQueryType[i].name,flag:!1}}else for(var i=0;i<$scope.coQueryType.length;i++)oldSelsectType[i]={name:originName,flag:!1};if(queryPriorityselected.length)for(var i=0;i<$scope.coPriority.length;i++)for(var originName1=$scope.coPriority[i].name,j=0;j<queryPriorityselected.length;j++){if(originName1===queryPriorityselected[j].name){oldPriority[i]={name:originName1,flag:!0};break}oldPriority[i]={name:originName1,flag:!1}}else for(var i=0;i<$scope.coPriority.length;i++)oldPriority[i]={name:$scope.coPriority[i].name,flag:!1};if(queryMarkSelected.length)for(var i=0;i<$scope.coMark.length;i++)for(var originName2=$scope.coMark[i].name,j=0;j<queryMarkSelected.length;j++){if(originName2===queryMarkSelected[j].name){oldMark[i]={name:originName2,flag:!0};break}oldMark[i]={name:originName2,flag:!1}}else for(var i=0;i<$scope.coMark.length;i++)oldMark[i]={name:$scope.coMark[i].name,flag:!1};sessionStorage.oldSelsectType=JSON.stringify(oldSelsectType),sessionStorage.oldPriority=JSON.stringify(oldPriority),sessionStorage.oldMark=JSON.stringify(oldMark),sessionStorage.queryTypeSelected=JSON.stringify(queryTypeSelected),sessionStorage.queryPriorityselected=JSON.stringify(queryPriorityselected),sessionStorage.queryMarkSelected=JSON.stringify(queryMarkSelected),sessionStorage.coopattr=$scope.coopattr+"",sessionStorage.searchkey=$scope.searchkey}var urlParams=$location.search();$scope.flag={},$scope.flag.homeLoading=!1,$scope.flag.isEmptyUrl=$.isEmptyObject(urlParams);var firstdeptid,searId,firstflag=!0,firstreackflag=!0,queryData={},sourceflag=urlParams.source?urlParams.source:"";$scope.scrollend=!1,$scope.flag.filterOk=!1,$scope.branchList=!1,$scope.searchkey=sessionStorage.searchkey?sessionStorage.searchkey:"",$scope.currentDate=Cooperation.getCurrentDate(),$scope.cooperationList=[],$scope.projectInfoList=[],queryData.count=20,queryData.deptId=!$scope.flag.isEmptyUrl&&urlParams.deptId>=-1?urlParams.deptId:"",queryData.modifyTime="",queryData.modifyTimeCount=0,queryData.ppid=urlParams.ppid?urlParams.ppid:"",queryData.queryFromBV=!0,queryData.searchType=sessionStorage.coopattr?parseInt(sessionStorage.coopattr):0,$scope.coopattr=sessionStorage.coopattr?sessionStorage.coopattr:"0",$scope.openSignal=!1,$scope.deptIdToken=0,$scope.ppidToken=0,$scope.deptIdOpenToken=0;var oldSelsectType=sessionStorage.oldSelsectType?JSON.parse(sessionStorage.oldSelsectType):[],oldPriority=sessionStorage.oldPriority?JSON.parse(sessionStorage.oldPriority):[],oldMark=sessionStorage.oldMark?JSON.parse(sessionStorage.oldMark):[];$scope.checkboxSelsectType=[],$scope.checkboxPriority=[],$scope.checkboxMark=[],$scope.coNoResult=!1,$scope.deptNoCo=!1,$scope.projNoCo=!1,$scope.searchNoCo=!1,$scope.noRelatedNoCo=!1;var queryTypeSelected=sessionStorage.queryTypeSelected?JSON.parse(sessionStorage.queryTypeSelected):[],queryPriorityselected=sessionStorage.queryPriorityselected?JSON.parse(sessionStorage.queryPriorityselected):[],queryMarkSelected=sessionStorage.queryMarkSelected?JSON.parse(sessionStorage.queryMarkSelected):[];queryData.groups=[],queryData.groups=queryData.groups.concat(assemblyGroups(queryTypeSelected,queryPriorityselected,queryMarkSelected)),Cooperation.getCoQueryFilter().then(function(data){$scope.coQueryFilterList=data,data[0].list.shift(),data[1].list.shift(),data[2].list.shift(),$scope.coQueryType=data[0].list,$scope.coPriority=data[2].list,$scope.coMark=data[1].list});var deptName=null,ppidName=null;$scope.openNew=function(){$scope.openSignal=!0,Cooperation.getTypeList().then(function(data){$(".overlay").css("top","0px"),$(".overlay").css("height","calc(100vh - 65px)"),$(".overlay").css("display","block"),angular.forEach(data,function(value,key){"问题整改"==value.name?data[key].typeImg=1:"阶段报告"==value.name?data[key].typeImg=2:"方案报审"==value.name?data[key].typeImg=3:"方案会签"==value.name?data[key].typeImg=4:"现场签证"==value.name?data[key].typeImg=5:"图纸变更"==value.name&&(data[key].typeImg=6)}),$scope.typeList=data,console.info("typeList",$scope.typeList)})},$scope.link=function(id){$(".operation").show(),$(".table-list")[0].scrollTop=0,$scope.coNoResult=!1,$scope.deptNoCo=!1,$scope.projNoCo=!1,$scope.searchNoCo=!1,$scope.noRelatedNoCo=!1,$scope.flag.isDraft=!1,$scope.deptIdOpenToken=0,searId=id,$scope.initScrollend(id),$scope.projectInfoList=[],$(".data_count").hide(),$scope.searchkey=$("#exampleInputName1").val(),queryData.searchKey=$scope.searchkey,firstflag&&queryData.groups.length<=0&&(queryTypeSelected=_.cloneDeep($scope.coQueryType),queryPriorityselected=_.cloneDeep($scope.coPriority),queryMarkSelected=_.cloneDeep($scope.coMark),queryData.groups=queryData.groups.concat(assemblyGroups(queryTypeSelected,queryPriorityselected,queryMarkSelected))),id==-1&&(queryData.deptId="",queryData.ppid=""),queryData.groups.length>0?Cooperation.getCollaborationList(queryData).then(function(data){$scope.cooperationList=data,$scope.markCheck&&$scope.priorityCheck&&$scope.typeCheck&&$scope.cooperationList.length<=0?($scope.coNoResult=!0,$scope.noRelatedNoCo=!0):!($scope.markCheck&&$scope.priorityCheck&&$scope.typeCheck)&&$scope.cooperationList.length<=0&&($scope.coNoResult=!0,$scope.searchNoCo=!0),queryData.deptId="",queryData.ppid=""}):($scope.coNoResult=!0,$scope.searchNoCo=!0),$(".general").removeClass("menusActive"),$("#draft").removeClass("menusActive"),$(".cop-filter, .cop-list, .btn_count").css("display","inline-block"),$(".basic-project").show()},$scope.drafts=function(id){if($scope.flag.isDraft=!0,$scope.deptIdOpenToken=0,searId=id,$scope.initScrollend(id),$scope.projectInfoList=[],queryData={},queryData.groups=[],queryData.count=20,queryData.queryFromBV=!0,queryData.modifyTimeCount=0,id==-1)queryData.deptId="",queryData.ppid="";else if(0==id){var group={type:605,value:{key:"0"}};queryData.groups.push(group)}$(".general").removeClass("menusActive"),$("#no-relate").removeClass("menusActive"),$(".cop-filter ,.cop-list ,.btn_count").css("display","none"),$(".draft-box").show(),Cooperation.getCollaborationList(queryData).then(function(data){$scope.cooperationList=data,queryData.deptId="",queryData.ppid="",$scope.cooperationList.isLock&&$(".table  tbody .problems-rect .problems-box").css("margin-left","40px")})},$scope.openfilter=function(){$scope.isCollapsed=!0,$(".overlay1").css("display","block"),$(".overlay1").css("top","59px"),$(".overlay1").css("height","calc(100vh - 115px)"),$(".operation-mask").css("display","block")},$scope.clicklay=function(){$scope.isCollapsed=!1,$scope.detailSignal=!1,$scope.openSignal=!1,$(".overlay").css("display","none"),$(".operation-mask").hide()},$scope.clicklay1=function(){$scope.isCollapsed=!1,$scope.detailSignal=!1,$scope.openSignal=!1,$(".overlay1").css("display","none"),$(".operation-mask").hide()},$scope.openDetail=function(item){$scope.detailSignal=!0,$(".overlay").css("top","0px"),
$(".overlay").css("height","calc(100vh - 65px)"),$(".overlay").css("display","block"),null!=item.deadline&&(item.deadline=item.deadline.substr(0,10)),$scope.everyDetail=item},$scope.trans=function(typeId,typeName){addSessionValue(),$state.go("newcopper",{typeid:typeId,typename:typeName,deptId:queryData.deptId,ppid:queryData.ppid,deptName:deptName,ppidName:ppidName},{location:"replace"})},Cooperation.getDeptInfo().then(function(data){$scope.deptInfoList=data,queryData.deptId||(firstdeptid=data[0].deptId,queryData.deptId=firstdeptid,$scope.deptIdToken=0)});$scope.getprojectInfoList=function(deptId,open,itemDeptName){ppidName="",deptName=itemDeptName,$(".container-fluid .operation").show(),$(".table-list")[0].scrollTop=0,$scope.coNoResult=!1,$scope.deptNoCo=!1,$scope.projNoCo=!1,$scope.searchNoCo=!1,$scope.noRelatedNoCo=!1,$scope.flag.isDraft=!1,$("#deptbutton_"+deptId).parent().addClass("menusActive"),$(":not(#deptbutton_"+deptId+")").parent().removeClass("menusActive");var createindex=layer.load(1,{shade:[.5,"#000"]});$scope.scrollend=!1,queryData.modifyTime="",queryData.modifyTimeCount=0,queryData.ppid="",$scope.projectInfoList=[],$scope.searchkey=$("#exampleInputName1").val(),queryData.searchKey=$scope.searchkey,$(".cop-filter, .cop-list, .btn_count").css("display","inline-block"),$(".basic-project").show();var ppid=urlParams.ppid?urlParams.ppid:"";open?($scope.deptIdOpenToken=1,layer.close(createindex)):(Cooperation.getProjectList(deptId).then(function(data){layer.close(createindex),getimgurl(data,deptId),ppid&&firstreackflag&&($("span[id='projectbutton_"+ppid+"']").click(),firstreackflag=!1)}),$scope.deptIdOpenToken=0),queryData.deptId||(queryData.deptId=deptId),queryData.deptId!=deptId&&(queryData.deptId=deptId),queryData.ppid||($scope.cooperationList=[],firstflag||0!=queryData.groups.length?(Cooperation.getCollaborationList(queryData).then(function(data){if($scope.cooperationList=data,$scope.cooperationList.length<=0){var groupsCheckAll=!1;$scope.coNoResult=!0,$scope.markCheck&&$scope.priorityCheck&&$scope.typeCheck&&(groupsCheckAll=!0),groupsCheckAll&&""==queryData.searchKey&&""==queryData.searchType?$scope.deptNoCo=!0:$scope.searchNoCo=!0}$scope.deptIdToken=1,$scope.deptIdOpenToken=0}),queryData.groups.length<=0&&(queryData.groups=queryData.groups.concat(assemblyGroups(queryTypeSelected,queryPriorityselected,queryMarkSelected))),firstflag=!1):$scope.cooperationList.length<=0&&($scope.coNoResult=!0,$scope.searchNoCo=!0),$(".data_count").hide())};var searchFlag,checkSearchInterval,pollingFlag=!0;$scope.addMoreData=function(){if(0==$scope.deptIdToken||1==$scope.ppidToken||1==$scope.deptIdOpenToken)return void($scope.ppidToken=0);if(1==token)return void(token=!1);if($scope.status&&!$scope.changeAttrToken)return void($scope.status=!1);if($scope.changeAttrToken)return void($scope.changeAttrToken=!1);if(!$scope.flag.filterOk){if($scope.cooperationList.length<20)return void($scope.scrollend=!0);setSearchFlagFalse(),pollingFlag&&(pollingFlag=!1,checkSearchInterval=setInterval(function(){checkCanSearch()},100)),setTimeout(function(){setSearchFlagTrue()},150)}};var setSearchFlagFalse=function(){searchFlag=!1},setSearchFlagTrue=function(){searchFlag=!0},checkCanSearch=function(){searchFlag&&(clearInterval(checkSearchInterval),$scope.searchMoreData(),pollingFlag=!0)};$scope.initScrollend=function(id){queryData.ppid!=id&&($scope.scrollend=!1,queryData.modifyTime="",queryData.modifyTimeCount=0)},$scope.searchMoreData=function(){if($scope.cooperationList.length){var count=0,size=$scope.cooperationList.length;queryData.modifyTime=$scope.cooperationList[size-1].updateTime;for(var i=0;i<size;i++)queryData.modifyTime==$scope.cooperationList[i].updateTime&&count++;queryData.modifyTimeCount=count}Cooperation.getCollaborationList(queryData).then(function(data){if($scope.cooperationList.length){if(data.length){for(var j=0;j<data.length;j++)$scope.cooperationList.push(data[j]);data.length<20&&($scope.scrollend=!0)}}else $scope.cooperationList=data})};var filterflag=!0;$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){if($(".table-list table tbody tr").click(function(){$(this).find(".cop-edit").show(),$(this).siblings().find(".cop-edit").hide()}),firstflag&&filterflag&&!sourceflag&&($scope.typeCheck=!0,$scope.priorityCheck=!0,$scope.markCheck=!0,$scope.allType(),$scope.allPriority(),$scope.allMark()),queryTypeSelected.length==$scope.coQueryType.length&&($scope.typeCheck=!0),queryPriorityselected.length==$scope.coPriority.length&&($scope.priorityCheck=!0),queryMarkSelected.length==$scope.coMark.length&&($scope.markCheck=!0),$scope.markCheck&&$scope.priorityCheck&&$scope.typeCheck?isCheck():isNotCheck(),"rember"===sourceflag&&filterflag){for(var typeIndex=[],typeIndexDefault=[],i=0;i<$scope.coQueryType.length;i++)typeIndexDefault.push(i);angular.forEach(queryTypeSelected,function(value,key){var findIndex=_.findIndex($scope.coQueryType,value);console.log(findIndex),typeIndex.push(findIndex)});for(var i=0;i<typeIndex.length;i++)$(".bg"+typeIndex[i]).addClass("bgs"+typeIndex[i]).removeClass("bg"+typeIndex[i]),$(".bg"+typeIndex[i]+" input, .bgs"+typeIndex[i]+" input").prop("checked",!1);for(var typeIndex=[],typeIndexDefault=[],i=0;i<$scope.coPriority.length;i++)typeIndexDefault.push(i);angular.forEach(queryPriorityselected,function(value,key){var findIndex=_.findIndex($scope.coPriority,value);typeIndex.push(findIndex)});for(var i=0;i<typeIndex.length;i++)$(".checkbox_priority_"+typeIndex[i]).prop("checked",!0);for(var typeIndex=[],typeIndexDefault=[],i=0;i<$scope.coMark.length;i++)typeIndexDefault.push(i);angular.forEach(queryMarkSelected,function(value,key){var findIndex=_.findIndex($scope.coMark,value);typeIndex.push(findIndex)});for(var i=0;i<typeIndex.length;i++)$(".checkbox_mark_"+typeIndex[i]).prop("checked",!0);queryTypeSelected.length===$scope.coQueryType.length?$("#allTypeId").prop("checked",!0):$("#allTypeId").prop("checked",!1),queryPriorityselected.length===$scope.coPriority.length?$("#allPriorityId").prop("checked",!0):$("#allPriorityId").prop("checked",!1),queryMarkSelected.length===$scope.coMark.length?$("#allMarkId").prop("checked",!0):$("#allMarkId").prop("checked",!1)}filterflag=!1}),$scope.$on("ngRepeatFinishedDept",function(ngRepeatFinishedEvent){firstreackflag&&(queryData.deptId&&0!=queryData.deptId&&queryData.deptId!=-1?($("#deptbutton_"+queryData.deptId).click(),$("#deptbutton_"+queryData.deptId).parent().addClass("menusActive")):queryData.deptId==-1?($scope.deptIdToken=1,$("#no-relate").click(),$("#no-relate").addClass("menusActive")):0==queryData.deptId?($scope.deptIdToken=1,$("#draft").click(),$("#draft").addClass("menusActive")):($("#deptbutton_"+firstdeptid).click(),$("#deptbutton_"+firstdeptid).parent().addClass("menusActive"))),$(".manage-menus").bind("click",function(){$("manage-menus").removeClass("menusActive"),$(this).addClass("menusActive").siblings().removeClass("menusActive")}),$scope.flag.isVisible=!0}),$scope.deleteProject=function(coid){layer.confirm("是否删除该协作？",{btn:["是","否"],move:!1},function(){layer.closeAll(),Cooperation.removeDraft(coid).then(function(data){}),$scope.drafts(0)})};var token=!1;$scope.getCollaborationList=function(ppid,projectName){$(".container-fluid .operation").show(),$(".table-list")[0].scrollTop=0,$scope.coNoResult=!1,$scope.deptNoCo=!1,$scope.projNoCo=!1,$scope.searchNoCo=!1,$scope.noRelatedNoCo=!1;var createindex=layer.load(1,{shade:[.5,"#000"]});return queryData.ppid==ppid&&1!=queryData.modifyTimeCount?void layer.close(createindex):(1==$scope.scrollend&&queryData.ppid!=ppid&&(token=!0),$scope.ppidToken=0,$scope.scrollend=!1,queryData.modifyTime="",queryData.modifyTimeCount=0,$scope.initScrollend(ppid),queryData.ppid=ppid,$scope.typeStatStr=[],0==queryData.searchType&&(queryData.searchType=""),ppidName=projectName,void Cooperation.getCollaborationList(queryData).then(function(data){if($scope.cooperationList=data,$scope.cooperationList.length<=0){var groupsCheckAll=!1;$scope.coNoResult=!0,$scope.markCheck&&$scope.priorityCheck&&$scope.typeCheck&&(groupsCheckAll=!0),!groupsCheckAll||""!=queryData.searchKey||""!=queryData.searchType&&0!=queryData.searchType?$scope.searchNoCo=!0:$scope.projNoCo=!0}$scope.ppidToken=1,layer.close(createindex)}))};var updateSelected=function(action,id,type,index,signal){var findIndex=_.findIndex(type,id),signalIs1=1==signal,signalIs2=2==signal,signalIs3=3==signal;"add"==action&&findIndex==-1&&type.push(id),"remove"==action&&findIndex!=-1&&type.splice(findIndex,1),"add"==action&&signalIs1&&$(".bg"+index).removeClass("bg"+index).addClass("bgs"+index),"remove"==action?signalIs1?($(".bgs"+index).removeClass("bgs"+index).addClass("bg"+index),$("#allTypeId").prop("checked",!1)):signalIs2?$("#allPriorityId").prop("checked",!1):signalIs3&&$("#allMarkId").prop("checked",!1):signalIs1?$scope.coQueryType.length==type.length&&($("#allTypeId").prop("checked",!0),$scope.typeCheck=!0):signalIs2?$scope.coPriority.length==type.length&&($("#allPriorityId").prop("checked",!0),$scope.priorityCheck=!0):signalIs3&&$scope.coMark.length==type.length&&($("#allMarkId").prop("checked",!0),$scope.markCheck=!0)};$scope.updateSelection=function($event,id,signal,index){var type,checkbox=$event.target,action=checkbox.checked?"add":"remove";({index:index,flag:checkbox.checked});switch(signal){case 1:type=queryTypeSelected,$scope.checkboxSelsectType[index]={index:index,checkbox:checkbox},console.log($scope.checkboxSelsectType[0]+"9090");break;case 2:type=queryPriorityselected,$scope.checkboxPriority[index]={index:index,checkbox:checkbox};break;case 3:type=queryMarkSelected,$scope.checkboxMark[index]={index:index,checkbox:checkbox}}switch(updateSelected(action,id,type,index,signal),signal){case 1:queryTypeSelected.length==$scope.coQueryType.length?$scope.typeCheck=!0:$scope.typeCheck=!1;break;case 2:queryPriorityselected.length==$scope.coPriority.length?$scope.priorityCheck=!0:$scope.priorityCheck=!1;break;case 3:queryMarkSelected.length==$scope.coMark.length?$scope.markCheck=!0:$scope.markCheck=!1}},$scope.isSelected=function(id){return queryTypeSelected.indexOf(id)>=0},$scope.allType=function(){if($scope.checkboxSelsectType=new Array($scope.coQueryType.length),firstflag&&!sourceflag)oldSelsectType=new Array($scope.coQueryType.length);else for(var i=0;i<$scope.checkboxSelsectType.length;i++)$scope.checkboxSelsectType[i]=$(".checkbox_type_"+i);if($scope.typeCheck){$(".type-check").find("input").prop("checked",!0),queryTypeSelected=_.cloneDeep($scope.coQueryType);for(var i=0;i<$scope.coQueryType.length;i++)if($(".bg"+i).removeClass("bg"+i).addClass("bgs"+i),firstflag&&!sourceflag){var type={name:$scope.coQueryType[i].name,flag:!0};oldSelsectType[i]=type}}else{for(var i=0;i<$scope.coQueryType.length;i++)if($(".bgs"+i).removeClass("bgs"+i).addClass("bg"+i),firstflag&&!sourceflag){var type={name:$scope.coQueryType[i].name,flag:!1};oldSelsectType[i]=type}$(".type-check").find("input").prop("checked",!1),queryTypeSelected=[]}},$scope.allPriority=function(){if($scope.checkboxPriority=new Array($scope.coPriority.length),firstflag&&!sourceflag)oldPriority=new Array($scope.coPriority.length);else for(var i=0;i<$scope.checkboxPriority.length;i++)$scope.checkboxPriority[i]=$(".checkbox_priority_"+i);if($(".priority-check label").addClass("input-check"),$scope.priorityCheck){if($(".priority-check").find("input").prop("checked",!0),queryPriorityselected=_.cloneDeep($scope.coPriority),firstflag&&!sourceflag)for(var i=0;i<$scope.coPriority.length;i++){var type={name:$scope.coPriority[i].name,flag:!0};oldPriority[i]=type}}else if($(".priority-check").find("input").prop("checked",!1),queryPriorityselected=[],firstflag&&!sourceflag)for(var i=0;i<$scope.coPriority.length;i++){var type={name:$scope.coPriority[i].name,flag:!1};oldPriority[i]=type,console.log(oldPriority+"comeon")}},$scope.allMark=function(){if($scope.checkboxMark=new Array($scope.coMark.length),firstflag&&!sourceflag)oldMark=new Array($scope.coMark.length);else for(var i=0;i<$scope.checkboxMark.length;i++)$scope.checkboxMark[i]=$(".checkbox_mark_"+i);if($scope.markCheck){if($(".mark-check").find("input").prop("checked",!0),queryMarkSelected=_.cloneDeep($scope.coMark),firstflag&&!sourceflag)for(var i=0;i<$scope.coMark.length;i++){var type={name:$scope.coMark[i].name,flag:!0};oldMark[i]=type}}else if($(".mark-check").find("input").prop("checked",!1),queryMarkSelected=[],firstflag&&!sourceflag)for(var i=0;i<$scope.coMark.length;i++){var type={name:$scope.coMark[i].name,flag:!1};oldMark[i]=type}},$scope.filterOk=function(){$scope.flag.filterOk=!0,$scope.coNoResult=!1,$scope.deptNoCo=!1,$scope.projNoCo=!1,$scope.searchNoCo=!1,$scope.noRelatedNoCo=!1,$scope.scrollend=!1,queryData.modifyTime="",queryData.modifyTimeCount=0,$(".operation-mask").css("display","none"),$scope.isCollapsed=!1,$(".overlay1").css("display","none");var groups=[];if(0==queryTypeSelected.length)for(var i=0;i<oldSelsectType.length;i++)oldSelsectType[i].flag=!1;else for(var i=0;i<oldSelsectType.length;i++)for(var oldName=oldSelsectType[i].name,j=0;j<queryTypeSelected.length;j++){var newName=queryTypeSelected[j].name;if(oldName==newName){oldSelsectType[i].flag=!0;break}oldSelsectType[i].flag=!1}if(0==queryPriorityselected.length)for(var i=0;i<oldPriority.length;i++)oldPriority[i].flag=!1;else for(var i=0;i<oldPriority.length;i++)for(var oldName=oldPriority[i].name,j=0;j<queryPriorityselected.length;j++){var newName=queryPriorityselected[j].name;if(oldName==newName){oldPriority[i].flag=!0;break}oldPriority[i].flag=!1}if(0==queryMarkSelected.length)for(var i=0;i<oldMark.length;i++)oldMark[i].flag=!1;else for(var i=0;i<oldMark.length;i++)for(var oldName=oldMark[i].name,j=0;j<queryMarkSelected.length;j++){var newName=queryMarkSelected[j].name;if(oldName==newName){oldMark[i].flag=!0;break}oldMark[i].flag=!1}groups=groups.concat(assemblyGroups(queryTypeSelected,queryPriorityselected,queryMarkSelected)),queryData.groups=groups,$scope.getCooperation(groups)},$scope.getCooperation=function(groups){null!=groups&&groups.length>0?(queryData.groups=groups,queryData.modifyTime=0,Cooperation.getCollaborationList(queryData).then(function(data){$scope.cooperationList=data,$scope.flag.filterOk=!1,data.length<20&&($scope.scrollend=!0),$scope.cooperationList.length<=0&&($scope.coNoResult=!0,$scope.searchNoCo=!0)})):($scope.cooperationList=[],$scope.cooperationList.length<=0&&($scope.coNoResult=!0,$scope.searchNoCo=!0))},$scope.filterCancel=function(){$(".operation-mask").css("display","none"),$scope.isCollapsed=!1,$(".overlay1").css("display","none");for(var typeLength=0,i=0;i<oldSelsectType.length;i++)oldSelsectType[i].flag?($(".bg"+i).removeClass("bg"+i).addClass("bgs"+i),$(".bg"+i+" input, .bgs"+i+" input").prop("checked",!0),typeLength++):($(".bgs"+i).removeClass("bgs"+i).addClass("bg"+i),$(".bg"+i+" input, .bgs"+i+" input").prop("checked",!1));oldSelsectType.length==typeLength?$("#allTypeId").prop("checked",!0):$("#allTypeId").prop("checked",!1);for(var priorityLength=0,i=0;i<oldPriority.length;i++)oldPriority[i].flag?($(".priority_"+i).attr("background","#979ba8"),$(".checkbox_priority_"+i).prop("checked",!0),priorityLength++):($(".priority_"+i).attr("background","#979ba8"),$(".checkbox_priority_"+i).prop("checked",!1));oldPriority.length==priorityLength?$("#allPriorityId").prop("checked",!0):$("#allPriorityId").prop("checked",!1);for(var markLength=0,i=0;i<oldMark.length;i++)oldMark[i].flag?($(".mark_"+i).attr("background","#979ba8"),$(".checkbox_mark_"+i).prop("checked",!0),markLength++):($(".mark_"+i).attr("background","#979ba8"),$(".checkbox_mark_"+i).prop("checked",!1));oldMark.length==markLength?$("#allMarkId").prop("checked",!0):$("#allMarkId").prop("checked",!1)},$scope.changeAttrToken=!1,$scope.status=!1,$scope.changeAttr=function(){return $(".table-list")[0].scrollTop=0,$scope.scrollend=!1,queryData.modifyTime="",queryData.modifyTimeCount=0,$scope.changeAttrs=!1,$scope.coNoResult=!1,$scope.deptNoCo=!1,$scope.projNoCo=!1,$scope.searchNoCo=!1,$scope.noRelatedNoCo=!1,queryData.searchType=parseInt($scope.coopattr),queryData.modifyTime=0,0==queryData.groups.length?($scope.coNoResult=!0,void($scope.searchNoCo=!0)):void Cooperation.getCollaborationList(queryData).then(function(data){$scope.cooperationList=data,$scope.changeAttrToken=!0,$scope.changeAttrs=!0,$scope.cooperationList.length<=0&&($scope.coNoResult=!0,$scope.searchNoCo=!0)})},$scope.getCollaborationListFun=function(){return $scope.coNoResult=!1,$scope.deptNoCo=!1,$scope.projNoCo=!1,$scope.searchNoCo=!1,$scope.noRelatedNoCo=!1,queryData.searchKey=$scope.searchkey,queryData.modifyTime=0,0==queryData.groups.length?($scope.coNoResult=!0,void($scope.searchNoCo=!0)):void Cooperation.getCollaborationList(queryData).then(function(data){$scope.cooperationList=data,$scope.cooperationList.length<=0&&($scope.coNoResult=!0,$scope.searchNoCo=!0)})},$scope.inputSearch=function(){0==searId?(queryData.deptId=0,$scope.getCollaborationListFun()):searId==-1?(queryData.deptId=-1,$scope.getCollaborationListFun()):(""==queryData.deptId&&(queryData.deptId=firstdeptid),$scope.getCollaborationListFun())},$scope.searchEnter=function(e){var keyCode=e.keyCode||e.which;""!=$("#exampleInputName1").val()&&13==keyCode?$scope.inputSearch():""==$("#exampleInputName1").val()&&($scope.cooperationList=[],0==searId?(queryData.deptId=searId,$scope.getCollaborationListFun()):(""==queryData.deptId&&(queryData.deptId=firstdeptid),$scope.getCollaborationListFun()))},$scope.getCoCountInfo=[];var arr=[];$scope.arrString=[];var priorityArr=[],arrCount=0,deadline=[];$scope.deadlineStr=[];var timeLim=[],timeName=[],deadlineCount=0,maker=[];$scope.makerStatStr=[];var blankId=[],blankName=[],makerCount=0,typeStatNub=[];$scope.typeStatStr=[];var coTypeObj=[],coTypeName=[],typeCount=0;$(".draft-box").css("display","none");$("#comboBox_count");$scope.comboxCount=function(){$(".basic-project").hide(),$(".draft-box").hide(),$(" .operation").hide(),$(" .data_count").show(),$("body").css("overflowX","hidden"),$scope.getCoTotal()},$(".data_back").click(function(){$(".data_count").hide(),$(".draft-box").css("display","none"),$(".container-fluid .operation").show(),$("body").css("overflowX","auto")}),$scope.getCoTotal=function(){priorityArr=[],timeLim=[],timeName=[],blankId=[],blankName=[],coTypeObj=[],coTypeName=[],$scope.arrString=[],$scope.deadlineStr=[],$scope.makerStatStr=[],$scope.typeStatStr=[],queryData.ppid||(queryData.ppid=""),$(".data_count").height($(window).height()-62),Cooperation.getCoStatisticsInfo({deptId:queryData.deptId,ppid:queryData.ppid}).then(function(data){function isEmpty(obj){for(var key in obj)return!1;return!0}function isEmptyArr(array){for(var count=0,i=0;i<array.length;i++)return count+=array[i]}$scope.getCoCountInfo=data.data,$scope.priorityStat=data.data.priorityStat,$scope.deadLineStat=data.data.deadLineStat,$scope.makerStat=data.data.makerStat,$scope.typeStat=data.data.typeStat,isEmpty($scope.priorityStat)?$(".data_every.first").hide():$(".data_every.first").show(),isEmpty($scope.deadLineStat)?$(".data_every.second").hide():$(".data_every.second").show(),isEmpty($scope.makerStat)?$(".data_every.third").hide():$(".data_every.third").show(),isEmpty($scope.typeStat)?$(".data_every.forth").hide():$(".data_every.forth").show();var isPriorityStat=isEmpty($scope.priorityStat),isDeadLineStat=isEmpty($scope.deadLineStat),isMakerStat=isEmpty($scope.makerStat),istypeStat=isEmpty($scope.typeStat);isPriorityStat?$("#data_graph").parent().hide():$("#data_graph").parent().show(),isDeadLineStat?$("#data_graph2").parent().hide():$("#data_graph2").parent().show(),isMakerStat?$("#data_graph3").parent().hide():$("#data_graph3").parent().show(),istypeStat?$("#data_graph4").parent().hide():$("#data_graph4").parent().show();var colorStyle1=["#5887FD","#E6D055","#73CC6C"];arr=[];var hasI=!1,hasII=!1,hasIII=!1,priorityLength=0;for(var x in $scope.priorityStat)"I"==x&&(hasI=!0),"II"==x&&(hasII=!0),"III"==x&&(hasIII=!0),priorityLength++;var value=0;hasI&&(value=$scope.priorityStat.I,$scope.arrString.push({name:"I",amount:value}),arr.push(value),priorityArr.push({value:value,name:"I",itemStyle:{normal:{color:""}}})),hasII&&(value=$scope.priorityStat.II,$scope.arrString.push({name:"II",amount:value}),arr.push(value),priorityArr.push({value:value,name:"II",itemStyle:{normal:{color:""}}})),hasIII&&(value=$scope.priorityStat.III,$scope.arrString.push({name:"III",amount:value}),arr.push(value),priorityArr.push({value:value,name:"III",itemStyle:{normal:{color:""}}})),arrCount=0;for(var n in arr)arrCount+=arr[n];angular.forEach($scope.priorityStat,function(value,key){0==isEmptyArr(arr)?$("#data_graph").parent().hide():$("#data_graph").parent().show()});for(var t=0;t<priorityArr.length;t++)priorityArr[t].itemStyle.normal.color=colorStyle1[t];deadline=[],deadlineCount=0,angular.forEach($scope.deadLineStat,function(val,key){deadline.push(val),$scope.deadlineStr.push({name:key,amount:val})});for(var m in deadline)deadlineCount+=deadline[m];angular.forEach($scope.deadLineStat,function(val,key){var dataTime={value:"",name:"",itemStyle:{normal:{color:""}}};dataTime.value=val,0==isEmptyArr(deadline)?$("#data_graph2").parent().hide():($("#data_graph2").parent().show(),dataTime.name=key),timeLim.push(dataTime),timeName.push(key)});for(var a=0;a<timeLim.length;a++)timeLim[a].itemStyle.normal.color=colorStyle1[a];maker=[],makerCount=0,angular.forEach($scope.makerStat,function(obj,key){maker.push(obj.count),$scope.makerStatStr.push({name:key,color:obj.color,amount:obj.count})});for(var i in maker)makerCount+=maker[i];angular.forEach($scope.makerStat,function(obj,key){var blank={value:"",name:"",itemStyle:{normal:{color:""}}};blank.value=obj.count,blank.itemStyle.normal.color=obj.color,0==isEmptyArr(maker)?$("#data_graph3").parent().hide():($("#data_graph3").parent().show(),blank.name=key),blankId.push(blank),blankName.push(key)}),typeStatNub=[],typeCount=0,angular.forEach($scope.typeStat,function(obj,key){typeStatNub.push(obj.count),$scope.typeStatStr.push({name:key,color:obj.color,amount:obj.count})});for(var k in typeStatNub)typeCount+=typeStatNub[k];angular.forEach($scope.typeStat,function(obj,key){var coType={value:"",name:"",itemStyle:{normal:{color:""}}};coType.value=obj.count,coType.itemStyle.normal.color=obj.color,0==isEmptyArr(typeStatNub)?$("#data_graph4").parent().hide():($("#data_graph4").parent().show(),coType.name=key),coTypeObj.push(coType),coTypeName.push(key)});for(var myChart1=echarts.init(document.getElementById("data_graph")),arrPriorityName=[],i=0;i<priorityArr.length;i++)arrPriorityName.push(priorityArr[i].name);var option1={tooltip:{trigger:"item",formatter:"{b} <br/> 数量 : {c} <br/> 比例 : {d}%",transitionDuration:0},title:{text:"优先级",x:"left",left:15,y:"10",padding:[10,67,10,0],textStyle:{fontSize:18,fontWeight:"normal",color:"#333",fontFamily:"Microsoft yahei"}},legend:{orient:"vertical",x:"left",left:15,padding:[10,78,10,0],itemGap:15,data:arrPriorityName,itemWidth:20,itemHeight:12,formatter:function(name){return 1==name.length?name+="  ":2==name.length&&(name+=" "),echarts.format.truncateText("  "+name,70,"14px Microsoft Yahei","…")},tooltip:{show:!0},top:"47",right:"50",align:"left",width:"500"},series:[{type:"pie",radius:["40%","60%"],avoidLabelOverlap:!1,center:["60%","50%"],label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"20",fontWeight:"bold",fontFamily:"Microsoft yahei"},formatter:"数量 : {c}\n\n比例 : {d}%"}},labelLine:{normal:{show:!0}},data:priorityArr}]};myChart1.setOption(option1);var myChart2=echarts.init(document.getElementById("data_graph2")),option2={tooltip:{trigger:"item",formatter:"{b} <br/> 数量 : {c} <br/> 比例 : {d}%",transitionDuration:0},title:{text:"期限",x:"left",y:10,left:15,padding:[10,84,10,0],textStyle:{fontSize:18,fontWeight:"normal",color:"#333",fontFamily:"Microsoft yahei"}},legend:{orient:"vertical",x:"left",itemGap:15,left:15,padding:[10,52,10,0],itemWidth:20,itemHeight:12,data:timeName,formatter:function(name){return echarts.format.truncateText("  "+name,70,"14px Microsoft Yahei","…")},tooltip:{show:!0},height:300,top:"47",right:"50",align:"left"},series:[{type:"pie",radius:["40%","60%"],avoidLabelOverlap:!1,center:["60%","50%"],label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"20",fontWeight:"bold",fontFamily:"Microsoft yahei"},formatter:"数量 : {c}\n\n比例 : {d}%"}},labelLine:{normal:{show:!0}},data:timeLim}]};myChart2.setOption(option2);for(var myChart3=echarts.init(document.getElementById("data_graph3")),tempName="",i=0;i<blankName.length;i++){var name=blankName[i];tempName.length<name.length&&(tempName=name)}var option3={tooltip:{trigger:"item",formatter:"{b} <br/> 数量 : {c} <br/> 比例 : {d}%",transitionDuration:0},title:{text:"标识",x:"left",y:"10",left:15,padding:[11,0,0],textStyle:{fontSize:18,fontWeight:"normal",color:"#333",fontFamily:"Microsoft yahei"}},legend:{width:100,orient:"vertical",x:"left",itemGap:15,itemWidth:20,itemHeight:12,left:10,data:blankName,formatter:function(name){return echarts.format.truncateText(" "+name,70,"14px Microsoft Yahei","...")},tooltip:{show:!0},height:300,top:"47",align:"left"},series:[{type:"pie",radius:["40%","60%"],avoidLabelOverlap:!1,center:["60%","50%"],label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"20",fontWeight:"bold",fontFamily:"Microsoft yahei",align:"left"},formatter:"数量 : {c}\n\n比例 : {d}%"}},labelLine:{normal:{show:!0}},data:blankId}]};myChart3.setOption(option3);var myChart4=echarts.init(document.getElementById("data_graph4")),option4={tooltip:{trigger:"item",formatter:"{b} <br/> 数量 : {c} <br/> 比例 : {d}%",transitionDuration:0},title:{text:"协作类型",x:"left",y:"10",left:14,padding:[11,0,0],textStyle:{fontSize:18,fontWeight:"normal",color:"#333",fontFamily:"Microsoft yahei"}},legend:{orient:"vertical",x:"left",itemGap:15,left:10,itemWidth:20,itemHeight:12,data:coTypeName,formatter:function(name){return echarts.format.truncateText("  "+name,70,"14px Microsoft Yahei","…")},tooltip:{show:!0},height:300,top:"47",align:"left"},series:[{type:"pie",radius:["40%","60%"],avoidLabelOverlap:!1,center:["60%","50%"],label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"20",fontWeight:"bold",fontFamily:"Microsoft yahei"},formatter:"数量 : {c}\n\n比例 : {d}%"}},labelLine:{normal:{show:!0}},data:coTypeObj}]};myChart4.setOption(option4),window.onresize=function(){myChart1.resize(),myChart2.resize(),myChart3.resize(),myChart4.resize(),$(".data_count").height($(window).height()-62)}})},$scope.transCoDetail=function(currentItem){addSessionValue(),$state.go("coopdetail",{coid:currentItem.coid},{location:"replace"})},"frombe"==urlParams.newcoop&&$timeout(function(){$(".new_cooper").click()}),"be"==$stateParams.transignal&&$scope.openNew(),$scope.branchType=function(){$scope.branchList=!1},$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){$(".sidebar").css("height",document.documentElement.clientHeight-$("header").height()-2),$(".manage-menus").click(function(){$(this).find(".menus-icon").toggleClass("rotate2")})}),$scope.$on("$viewContentLoaded",function(event){$scope.flag.homeLoading=!0})}]),$(window).resize(function(){var headerHeight=$("header").height(),allHeight=document.documentElement.clientHeight;$(".sidebar").css("height",allHeight-headerHeight-2),$("#content-b1").css("height",allHeight-headerHeight-2),$("#content-a3").css("height",allHeight-headerHeight-2),$(".data_list").css("height",allHeight-headerHeight-$(".data_Totle").height()-2),$(".data_count").css("height",allHeight-headerHeight-$(".data_Totle").height()-2)}),$(document).ready(function(){$(document).bind("click",function(e){for(var e=e||window.event,select=e.target||e.srcElement,option=e.target||e.srcElement;select;){if(select.id&&"project-select"==select.id)return void $("#project-option").toggle();select=select.parentNode}for(;option;){if(option.id&&"project-option"==option.id)return;option=option.parentNode}$("#project-option").css("display","none")})});var level=0,allDoc;angular.module("cooperation").controller("linkbeCtrl",["$scope","$http","$uibModalInstance","Cooperation","items","$timeout",function($scope,$http,$uibModalInstance,Cooperation,items,$timeout){function onCheck(event,treeId,treeNode){treeObj=$.fn.zTree.getZTreeObj("tree"),nodes=treeObj.getCheckedNodes(!0);var unit=_.filter(nodes,function(o){return 2===o.type}),tempselectedItem=[];angular.forEach(unit,function(value,key){tempselectedItem.push(value.value)}),selectedItem=tempselectedItem,selectedItem.length?getDocList():$scope.$apply(function(){$scope.totalItems=0,$scope.docList=[]})}function initProjectSelected(data){$scope.projectSelected.projectName=data.projectName,$scope.projectOption=data.ppid,"土建预算"==data.projectType?$scope.projectSelected.typeImg="imgs/icon/1.png":"钢筋预算"==data.projectType?$scope.projectSelected.typeImg="imgs/icon/2.png":"安装预算"==data.projectType?$scope.projectSelected.typeImg="imgs/icon/3.png":"Revit"==data.projectType?$scope.projectSelected.typeImg="imgs/icon/4.png":"Tekla"==data.projectType?$scope.projectSelected.typeImg="imgs/icon/5.png":"PDF"==data.projectType&&($scope.projectSelected.typeImg="imgs/icon/6.png")}$scope.selectedOption={},$scope.projectOption=null,$scope.projectSelected={},$scope.currentPage=1,$scope.deptInfo={availableOptions:[]},$scope.projectList={availableOptions:[]},$scope.totalItems=0;var deptId,ppid,treeObj,nodes,setting={view:{selectedMulti:!1},check:{enable:!0},callback:{onCheck:onCheck,onCollapse:function(event,treeId,treeNode){level=treeNode.level},onExpand:function(event,treeId,treeNode){level=treeNode.level}}},selectedItem=[],queryData={ppid:"",tagids:[],searchText:"",pageInfo:{}};Cooperation.getDeptList().then(function(data){$scope.deptInfo.availableOptions=data,$scope.selectedOption=$scope.deptInfo.availableOptions[0].deptId+"",deptId=$scope.selectedOption,deptId&&$timeout(function(){$(".selectpicker1").selectpicker({style:"",size:"auto"})},0),Cooperation.projectList(deptId).then(function(data){$scope.projectList.availableOptions=data,$scope.projectOption=$scope.projectList.availableOptions[0].ppid+"",ppid=data[0].ppid,ppid&&$timeout(function(){$(".selectpicker2").selectpicker({style:"",size:"auto"})},0),initProjectSelected(data[0])})});var getDocList=function(){queryData.ppid=$scope.projectOption,queryData.tagids=selectedItem,queryData.searchText=$scope.searchname,queryData.pageInfo={currentPage:$scope.currentPage?$scope.currentPage:1,pageSize:10},Cooperation.getDocList(queryData).then(function(data){allDoc=data.result,$scope.docList=data.result;var typeArr=["txt","doc","pdf","ppt","docx","xlsx","xls","pptx","jpeg","bmp","PNG","GIF","JPG","TXT","DOC","PDF","PPT","DOCX","XLSX","PPTX","JPEG","BMP","png","jpg","gif","dwg","rar","zip","avi","mp4","mov","flv","swf","wmv","mpeg","mpg","mp3"];angular.forEach(data.result,function(value,key){typeArr.indexOf(value.fileType)==-1&&(value.fileType="other")}),$scope.totalItems=data.pageInfo.totalNumber,$timeout(function(){allSelectStatus()},50)})};$scope.pageChanged=function(){getDocList(),$timeout(function(){allSelectStatus()},50)};var a=_.cloneDeep(items),docSelected=a?a:[],updateSelected=function(action,id){var findIndex=_.findIndex(docSelected,id);if("add"==action&&findIndex==-1&&docSelected.push(id),"remove"==action&&findIndex!=-1){docSelected.indexOf(id);docSelected.splice(findIndex,1)}};$scope.updateSelection=function($event,id){var checkbox=$event.target,action=checkbox.checked?"add":"remove";updateSelected(action,id),allSelectStatus()},$scope.isSelected=function(id){return _.findIndex(docSelected,id)>=0},$scope.dataAllSelected=function($event){var index=0;$event.target.checked?$(".check-now input[type=checkbox]").each(function(){$(this).attr("checked",!0),updateSelected("add",allDoc[index]),index++}):$(".check-now input[type=checkbox]").each(function(){$(this).attr("checked",!1),updateSelected("remove",allDoc[index]),index++})},$scope.docSearch=function(){getDocList(queryData)},$scope.ok=function(){$uibModalInstance.close(docSelected);
},$scope.switchDept=function(params){deptId=params,Cooperation.projectList(params).then(function(data){void 0!=data[0]?($(".project-selected img").css("display","block"),$(".project-selected .bs-caret").removeClass("downBoxPosition"),$("#tree").css("display","block"),$scope.projectOption=data[0].ppid+"",initProjectSelected(data[0])):(data=[{projectName:"空"}],$scope.projectSelected.projectName="空",$(".project-selected img").css("display","none"),$(".project-selected .bs-caret").addClass("downBoxPosition"),$("#tree").css("display","none")),$scope.projectList.availableOptions=data})},$scope.changeSelected=function(item){initProjectSelected(item),$scope.isCollapsed=!1};var getDocTagList=function(params){Cooperation.getDocTagList(params).then(function(data){var treeObj=$.fn.zTree.init($("#tree"),setting,data);treeObj.expandNode(treeObj.transformToArray(treeObj.getNodes())[0],!0,!1,!0,!1)})};$scope.switchPpid=function(projectOption){ppid=projectOption,getDocTagList(ppid)},$scope.$watch("projectOption",function(newVal,oldVal){null!=newVal&&$scope.switchPpid($scope.projectOption)}),$scope.cancel=function(){$uibModalInstance.dismiss()},$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){$(".check-now").click(function(){$(this).css("background","#eceef0").siblings().css("background","#fff")})}),$scope.expand=function(){var obj={type:"expand",operObj:"tree",level:level};level=Cooperation.openOrClose(obj),$("#content-a6")[0].scrollTop=0},$scope.collapse=function(){var obj={type:"collapse",operObj:"tree",level:level};level=Cooperation.openOrClose(obj),$("#content-a6")[0].scrollTop=0},$scope.myKeyup=function(e){var keycode=window.event?e.keyCode:e.which;13!=keycode&&""!=$("#linkbeSear").val()||$scope.docSearch()},$scope.blurCancle=function(){$scope.isCollapsed=!1}}]);var level=1,maxLevel=-1;angular.module("cooperation").controller("linkcomponentCtrl",["$scope","$http","$uibModalInstance","Cooperation",function($scope,$http,$uibModalInstance,Cooperation){function findAllChilds(data){for(var x=0;x<data.length;x++)1==data[x].type?data[x].iconSkin="org":2==data[x].type?data[x].iconSkin="dept":3==data[x].type&&0==data[x].value.indexOf("1-3-")?data[x].iconSkin="tj":3==data[x].type&&0==data[x].value.indexOf("2-3-")?data[x].iconSkin="gj":3==data[x].type&&0==data[x].value.indexOf("3-3-")?data[x].iconSkin="az":3==data[x].type&&0==data[x].value.indexOf("4-3-")?data[x].iconSkin="revit":3==data[x].type&&0==data[x].value.indexOf("5-3-")&&(data[x].iconSkin="tekla"),null!=data[x].children&&data[x].children.length>0&&findAllChilds(data[x].children)}function categoryprojtype(node){maxlevel<node.level&&(maxlevel=node.level);var str0=node.value.split("-")[0],str1=node.value.split("-")[1],str2=node.value.split("-")[2];initPpid.push(str2),projTypeSearchPpid.push(str2),TextSearchPpid.push(str2),functionSearchPpid.push(str2),"2"==str1?pdfppidstore.push(str2):"1"==str0?tjnodestore.push(str2):"2"==str0?gjnodestore.push(str2):"3"==str0?aznodestore.push(str2):"4"==str0?revitnodestore.push(str2):"5"==str0&&teklanodestore.push(str2)}function zTreeOnClick(event,treeId,treeNode){dataList.linkProjectSelected=treeNode,dataList.assembleLps=treeNode,ppid=dataList.assembleLps.value.split("-")[2],projType=dataList.assembleLps.value.split("-")[0],console.log("treeNode",treeNode),1==treeNode.isParent?($scope.flagok=!0,$scope.$apply()):($scope.flagok=!1,$scope.$apply()),treeObj=$.fn.zTree.getZTreeObj("tree");var sNodes=treeObj.getSelectedNodes();if(sNodes.length>0)var node=sNodes[0].getParentNode();dataList.parentNode=node}function projTypeSwitch(n){switch(n){case 0:return null;case 1:return tjnodestore;case 2:return gjnodestore;case 3:return aznodestore;case 4:return revitnodestore;case 5:return teklanodestore;case 6:return pdfppidstore}}function filterchild(node){var searchname=$scope.formText;return 3==node.type&&node.name.indexOf(searchname)>-1}function searchByText(){for(var shownodes=treeObj.getNodesByFilter(filterchild),TextSearchPpid=[],i=0;i<shownodes.length;i++){var str2=shownodes[i].value.split("-")[2];TextSearchPpid.push(str2)}return TextSearchPpid}function filterhidechild(node){return 3==node.type}function filterbyppid(node){return 3==node.type&&searchPpid.indexOf(node.value.split("-")[2])>-1}function hideparentnode(){for(var i=maxlevel-1;i>0;i--){selectlevel=i;for(var parentnodes=treeObj.getNodesByFilter(filterbylevel),needhidenods=[],j=0;j<parentnodes.length;j++){var childnodes=parentnodes[j].children,ishide=!0;if(null!=childnodes)for(var n=0;n<childnodes.length;n++)childnodes[n].isHidden||(ishide=!1);else ishide=!0;ishide&&needhidenods.push(parentnodes[j])}treeObj.hideNodes(needhidenods)}}function filterbylevel(node){return node.level==selectlevel&&3!=node.type}var refreshID;$scope.projtype="0",$scope.functionOption="0";var ppid,projType,treeObj,nodelist=[],tjnodestore=[],gjnodestore=[],aznodestore=[],revitnodestore=[],teklanodestore=[],pdfppidstore=[],projTypeSearchPpid=[],TextSearchPpid=[],functionSearchPpid=[],initPpid=[],searchPpid=[],maxlevel=0,dataList={},setting={view:{selectedMulti:!1},callback:{onClick:zTreeOnClick,onCollapse:function(event,treeId,treeNode){level=treeNode.level},onExpand:function(event,treeId,treeNode){level=treeNode.level}}};$scope.projectTree=[],$scope.flagok=!0,Cooperation.getProjectTree().then(function(data){findAllChilds(data),$scope.projectTree=data,treeObj=$.fn.zTree.init($("#tree"),setting,$scope.projectTree),treeObj.expandAll(!0),nodelist=treeObj.transformToArray(treeObj.getNodes());for(var i=0;i<nodelist.length;i++)nodelist[i].level>=maxLevel&&(maxLevel=nodelist[i].level),3==nodelist[i].type&&categoryprojtype(nodelist[i]);level=maxLevel});var searchFlag,checkSearchInterval,pollingFlag=!0;$scope.delayTreeSearch=function(type){setSearchFlagFalse(),pollingFlag&&(pollingFlag=!1,checkSearchInterval=setInterval(function(){checkCanSearch(type)},250)),setTimeout(function(){setSearchFlagTrue()},500),level=Cooperation.expandAll("tree")};var setSearchFlagFalse=function(){searchFlag=!1},setSearchFlagTrue=function(){searchFlag=!0},checkCanSearch=function(type){searchFlag&&(clearInterval(checkSearchInterval),$scope.treeSearch(type),pollingFlag=!0)};$scope.treeSearch=function(type){if(treeObj.showNodes(nodelist),1==type&&(projTypeSearchPpid=0==$scope.projtype?initPpid:projTypeSwitch(parseInt($scope.projtype))),2==type)if(0==$scope.functionOption)functionSearchPpid=initPpid;else{var projTypeTextPpid=_.intersection(projTypeSearchPpid,TextSearchPpid);functionSearchPpid=[],functionFilter(projTypeTextPpid)}3==type&&(TextSearchPpid=""==$scope.formText||null==$scope.formText||"underfined"==$scope.formText?initPpid:searchByText()),searchPpid=_.intersection(projTypeSearchPpid,functionSearchPpid,TextSearchPpid);var showchildnodes=treeObj.getNodesByFilter(filterbyppid),hidenodes=treeObj.getNodesByFilter(filterhidechild);treeObj.hideNodes(hidenodes),treeObj.showNodes(showchildnodes),hideparentnode(),level=Cooperation.expandAll("tree")};var selectlevel,functionFilter=function(projTypeTextPpid){var data={},infoType=parseInt("1200"+$scope.functionOption);data.infoType=infoType,data.ppids=projTypeTextPpid,data=JSON.stringify(data),$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"post",data:data,url:basePath+"rs/co/getProjTipInfo",async:!1,success:function(data){for(var i=0;i<data.length;i++){var ppid=data[i]+"";functionSearchPpid.push(ppid)}},error:function(){}})};$scope.ok=function(){function refreshState(){var reCode=BimCo.GetSelectComponentStatus(ppid);switch(reCode){case"001":$uibModalInstance.close(dataList),clearRefreshInterval();break;case"002":clearRefreshInterval()}}function setRefreshInterval(){refreshID=setInterval(refreshState,1e3),console.log("我是轮询")}function clearRefreshInterval(){clearInterval(refreshID)}dataList.assembleLps=[{ppid:ppid,projType:projType}],BimCo.SelectComponent(ppid),setRefreshInterval()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.expand=function(){var obj={type:"expand",operObj:"tree",level:level};level=Cooperation.openOrClose(obj),$("#content-a12")[0].scrollTop=0},$scope.collapse=function(){var obj={type:"collapse",operObj:"tree",level:level};level=Cooperation.openOrClose(obj),$("#content-a12")[0].scrollTop=0}}]),angular.module("cooperation").controller("linkformCtrl",["$scope","$http","$uibModalInstance","Cooperation","items","$timeout",function($scope,$http,$uibModalInstance,Cooperation,items,$timeout){$scope.selectedTypeId=items.typeid,Cooperation.getTypeList().then(function(data){$scope.typeList=data,$timeout(function(){$(".selectpicker").selectpicker({style:"",size:"auto"})})}),Cooperation.getTemplateNode(items.typeid).then(function(data){$scope.templateNode=data}),$scope.switchType=function(selectedTypeId){Cooperation.getTemplateNode(selectedTypeId).then(function(data){$scope.templateNode=data})};var a=_.cloneDeep(items.formSelectedList),formSelected=a?a:[],updateSelected=function(action,id,name){var findIndex=_.findIndex(formSelected,id);"add"==action&&findIndex==-1&&formSelected.push(id),"remove"==action&&findIndex!=-1&&formSelected.splice(findIndex,1)};$scope.updateSelection=function($event,id){var checkbox=$event.target,action=checkbox.checked?"add":"remove";updateSelected(action,id,checkbox.name)},$scope.isSelected=function(id){return _.findIndex(formSelected,id)>=0},$scope.ok=function(){$uibModalInstance.close(formSelected)},$scope.cancel=function(){$uibModalInstance.dismiss()},$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){$(".tab-tr").on("click",function(){$(this).css("background","#eceef0").siblings().css("background","#fff")})})}]);var level=1,maxLevel=-1,levelCategory=1;angular.module("cooperation").controller("linkprojectCtrl",["$scope","$http","$uibModalInstance","Cooperation",function($scope,$http,$uibModalInstance,Cooperation){function findAllChilds(data){for(var x=0;x<data.length;x++)1==data[x].type?data[x].iconSkin="org":2==data[x].type?data[x].iconSkin="dept":3==data[x].type&&0==data[x].value.indexOf("1-3-")?data[x].iconSkin="tj":3==data[x].type&&0==data[x].value.indexOf("2-3-")?data[x].iconSkin="gj":3==data[x].type&&0==data[x].value.indexOf("3-3-")?data[x].iconSkin="az":3==data[x].type&&0==data[x].value.indexOf("4-3-")?data[x].iconSkin="revit":3==data[x].type&&0==data[x].value.indexOf("5-3-")&&(data[x].iconSkin="tekla"),null!=data[x].children&&data[x].children.length>0&&findAllChilds(data[x].children)}function categoryprojtype(node){maxlevel<node.level&&(maxlevel=node.level);var str0=node.value.split("-")[0],str1=node.value.split("-")[1],str2=node.value.split("-")[2];initPpid.push(str2),projTypeSearchPpid.push(str2),TextSearchPpid.push(str2),functionSearchPpid.push(str2),"2"==str1?pdfppidstore.push(str2):"1"==str0?tjnodestore.push(str2):"2"==str0?gjnodestore.push(str2):"3"==str0?aznodestore.push(str2):"4"==str0?revitnodestore.push(str2):"5"==str0&&teklanodestore.push(str2)}function zTreeOnClick(event,treeId,treeNode){dataList.linkProjectSelected=treeNode,dataList.assembleLps=treeNode,ppid=dataList.assembleLps.value.split("-")[2],projType=dataList.assembleLps.value.split("-")[0],1==treeNode.isParent?($scope.flagok=!0,$scope.$apply()):($scope.flagok=!1,$scope.$apply()),treeObj=$.fn.zTree.getZTreeObj("tree");var sNodes=treeObj.getSelectedNodes();if(sNodes.length>0)var node=sNodes[0].getParentNode();dataList.parentNode=node}function onCheckZtree(){var selectedNodes=[],treeObj=$.fn.zTree.getZTreeObj("tree1");selectedNodes=treeObj.getCheckedNodes(!0),selectedNodes.length&&($scope.flagok=!1,$scope.$apply())}function projTypeSwitch(n){switch(n){case 0:return null;case 1:return tjnodestore;case 2:return gjnodestore;case 3:return aznodestore;case 4:return revitnodestore;case 5:return teklanodestore;case 6:return pdfppidstore}}function filterchild(node){var searchname=$scope.formText;return 3==node.type&&node.name.indexOf(searchname)>-1}function searchByText(){for(var shownodes=treeObj.getNodesByFilter(filterchild),TextSearchPpid=[],i=0;i<shownodes.length;i++){var str2=shownodes[i].value.split("-")[2];TextSearchPpid.push(str2)}return TextSearchPpid}function filterhidechild(node){return 3==node.type}function filterbyppid(node){return 3==node.type&&searchPpid.indexOf(node.value.split("-")[2])>-1}function hideparentnode(){for(var i=maxlevel-1;i>0;i--){selectlevel=i;for(var parentnodes=treeObj.getNodesByFilter(filterbylevel),needhidenods=[],j=0;j<parentnodes.length;j++){var childnodes=parentnodes[j].children,ishide=!0;if(null!=childnodes)for(var n=0;n<childnodes.length;n++)childnodes[n].isHidden||(ishide=!1);else ishide=!0;ishide&&needhidenods.push(parentnodes[j])}treeObj.hideNodes(needhidenods)}}function filterbylevel(node){return node.level==selectlevel&&3!=node.type}$scope.openSignal=!0,$scope.projtype="0",$scope.functionOption="0";var ppid,projType,treeObj,nodelist=[],tjnodestore=[],gjnodestore=[],aznodestore=[],revitnodestore=[],teklanodestore=[],pdfppidstore=[],projTypeSearchPpid=[],TextSearchPpid=[],functionSearchPpid=[],initPpid=[],searchPpid=[],maxlevel=0,dataList={},setting={view:{selectedMulti:!1},callback:{onClick:zTreeOnClick,onCollapse:function(event,treeId,treeNode){level=treeNode.level,levelCategory=treeNode.level},onExpand:function(event,treeId,treeNode){level=treeNode.level,levelCategory=treeNode.level}}};$scope.projectTree=[],$scope.openSignal=!0,$scope.flagok=!0,Cooperation.getProjectTree().then(function(data){findAllChilds(data),$scope.projectTree=data,treeObj=$.fn.zTree.init($("#tree"),setting,$scope.projectTree),treeObj.expandAll(!0),nodelist=treeObj.transformToArray(treeObj.getNodes());for(var i=0;i<nodelist.length;i++)nodelist[i].level>=maxLevel&&(maxLevel=nodelist[i].level),3==nodelist[i].type&&categoryprojtype(nodelist[i]);level=maxLevel,levelCategory=maxLevel}),$scope.ok=function(){switch(projType){case"1":projType="土建预算";break;case"2":projType="钢筋预算";break;case"3":projType="安装预算";break;case"4":projType="Revit";break;case"5":projType="Tekla"}dataList.assembleLps=[{ppid:ppid,projType:projType}],$uibModalInstance.close(dataList)},$scope.ok3=function(){$scope.flagok=!0,$scope.openSignal=!1,$scope.projectTree=[];var obj={ppid:ppid,projType:projType},params=JSON.stringify(obj),setting1={view:{selectedMulti:!1},check:{enable:!0},callback:{onCheck:onCheckZtree}};dataList.assembleLps=obj,Cooperation.getFloorCompClassList(params).then(function(data){$scope.projectTree=data;var treeObj=$.fn.zTree.init($("#tree1"),setting1,$scope.projectTree);treeObj.expandAll(!0);for(var treeNodes=treeObj.transformToArray(treeObj.getNodes()),i=0;i<treeNodes.length;i++)treeNodes[i].level>=maxLevel&&(maxLevel=treeNodes[i].level);level=maxLevel})},$scope.ok4=function(){function getParentNodeList(treeObj){if(null!=treeObj){var pNode=treeObj.getParentNode();return null!=pNode&&(pNodeList.push(pNode),pNode=getParentNodeList(pNode)),pNodeList}}var selectedNodes=[],selectedNodesList=[],pNodeList=[],treeObj=$.fn.zTree.getZTreeObj("tree1");selectedNodes=treeObj.getCheckedNodes(!0),console.log("selectedNodes",selectedNodes);var lastNodeList=_.filter(selectedNodes,function(value,key){return 5!=projType?3==value.type:2==value.type});switch(angular.forEach(lastNodeList,function(value,key){pNodeList=[];var signalSelected=getParentNodeList(value,pNodeList).concat(value);selectedNodesList.push(signalSelected)}),console.log("selectedNodesList",selectedNodesList),projType){case"1":projType="土建预算";break;case"2":projType="钢筋预算";break;case"3":projType="安装预算";break;case"4":projType="Revit";break;case"5":projType="Tekla"}var selectedCategory=[];angular.forEach(selectedNodesList,function(value,key1){var unit={};angular.forEach(value,function(value1,key1){0===value1.type?unit.floor=value1.value:1===value1.type?unit.spec=value1.value:2===value1.type?unit.compClass=value1.value:3===value1.type&&(unit.subClass=value1.value)}),unit.ppid=ppid,unit.projType=projType,selectedCategory.push(unit)}),dataList.assembleLps=selectedCategory,console.log("dataList",dataList),$uibModalInstance.close(dataList)};var searchFlag,checkSearchInterval,pollingFlag=!0;$scope.delayTreeSearch=function(type,status){setSearchFlagFalse(),pollingFlag&&(pollingFlag=!1,checkSearchInterval=setInterval(function(){checkCanSearch(type)},250)),setTimeout(function(){setSearchFlagTrue()},500),1==status?level=Cooperation.expandAll("tree"):2==status&&(levelCategory=Cooperation.expandAll("tree"))};var setSearchFlagFalse=function(){searchFlag=!1},setSearchFlagTrue=function(){searchFlag=!0},checkCanSearch=function(type){searchFlag&&(clearInterval(checkSearchInterval),$scope.treeSearch(type),pollingFlag=!0)};$scope.treeSearch=function(type,status){if(treeObj.showNodes(nodelist),1==type&&(projTypeSearchPpid=0==$scope.projtype?initPpid:projTypeSwitch(parseInt($scope.projtype))),2==type)if(0==$scope.functionOption)functionSearchPpid=initPpid;else{var projTypeTextPpid=_.intersection(projTypeSearchPpid,TextSearchPpid);functionSearchPpid=[],functionFilter(projTypeTextPpid)}3==type&&(TextSearchPpid=""==$scope.formText||null==$scope.formText||"underfined"==$scope.formText?initPpid:searchByText()),searchPpid=_.intersection(projTypeSearchPpid,functionSearchPpid,TextSearchPpid);var showchildnodes=treeObj.getNodesByFilter(filterbyppid),hidenodes=treeObj.getNodesByFilter(filterhidechild);treeObj.hideNodes(hidenodes),treeObj.showNodes(showchildnodes),hideparentnode(),1==status?level=Cooperation.expandAll("tree"):2==status&&(levelCategory=Cooperation.expandAll("tree"))};var selectlevel,functionFilter=function(projTypeTextPpid){var data={},infoType=parseInt("1200"+$scope.functionOption);data.infoType=infoType,data.ppids=projTypeTextPpid,data=JSON.stringify(data),$.ajax({contentType:"application/json; charset=utf-8",dataType:"json",type:"post",data:data,url:basePath+"rs/co/getProjTipInfo",async:!1,success:function(data){for(var i=0;i<data.length;i++){var ppid=data[i]+"";functionSearchPpid.push(ppid)}},error:function(){}})};$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.expand=function(status){if(1==status){var obj={type:"expand",operObj:"tree",level:level};level=Cooperation.openOrClose(obj),$("#content-a11")[0].scrollTop=0}else if(2==status){var obj={type:"expand",operObj:"tree",level:levelCategory};levelCategory=Cooperation.openOrClose(obj),$("#content-a13")[0].scrollTop=0}},$scope.collapse=function(status){if(1==status){var obj={type:"collapse",operObj:"tree",level:level};level=Cooperation.openOrClose(obj),$("#content-a11")[0].scrollTop=0}else if(2==status){var obj={type:"collapse",operObj:"tree",level:levelCategory};levelCategory=Cooperation.openOrClose(obj),$("#content-a13")[0].scrollTop=0}}}]),angular.module("cooperation").controller("newcoopreationCtrl",["$scope","$http","$uibModal","$httpParamSerializer","FileUploader","Cooperation","$state","$stateParams","Common","Manage","$sce","alertService","headerService","$timeout",function($scope,$http,$uibModal,$httpParamSerializer,FileUploader,Cooperation,$state,$stateParams,Common,Manage,$sce,alertService,headerService,$timeout){function isDelete(num){$scope.linkProject1||$scope.linkComponent1||$scope.linkCategoty1||$scope.link.linkProjectName?layer.confirm("您已关联的模型,是否重新关联？",{btn:["是","否"],move:!1},function(){layer.closeAll(),$scope.linkProjectClick?(modalInstance=$uibModal.open({windowClass:"link-project-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/link_project.html",controller:"linkprojectCtrl"}),modalInstance.result.then(function(dataList){$scope.link.linkProjectName=dataList.linkProjectSelected.name,$scope.link.linkProjectDptName=dataList.parentNode.name,$scope.link.linkProjectDptName&&($(".new-del").show(),$scope.data.bindType=1,$scope.linkProject1=!0,$scope.linkComponent1=!1,$scope.linkCategoty1=!1),$scope.data.assembleLps=dataList.assembleLps,console.info("dataList.assembleLps",dataList.assembleLps),$scope.data.ppid=dataList.assembleLps[0].ppid,$scope.data.deptId=dataList.parentNode.value})):$scope.linkComponentClick?(modalInstance=$uibModal.open({windowClass:"link-component-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/link_component.html",controller:"linkcomponentCtrl"}),modalInstance.result.then(function(dataList){$scope.link.linkProjectDptName=dataList.parentNode.name,$scope.link.linkProjectName=dataList.linkProjectSelected.name,$scope.data.assembleLps=dataList.assembleLps,$scope.data.deptId=dataList.parentNode.value,$scope.data.ppid=dataList.assembleLps[0].ppid,$scope.link.linkProjectDptName&&($(".new-del").show(),$scope.data.bindType=2,$scope.linkProject1=!1,$scope.linkComponent1=!0,$scope.linkCategoty1=!1)})):$scope.linkCategotyClick&&(modalInstance=$uibModal.open({windowClass:"link-categoty-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/link_component_category.html",controller:"linkprojectCtrl"}),modalInstance.result.then(function(dataList){$scope.link.linkProjectName=dataList.linkProjectSelected.name,$scope.link.linkProjectDptName=dataList.parentNode.name,$scope.linkProjectSelected=dataList.selectedCategory,$scope.data.assembleLps=dataList.assembleLps,$scope.data.deptId=dataList.parentNode.value,$scope.data.ppid=dataList.assembleLps[0].ppid,console.log("ppid",dataList.assembleLps.ppid),$scope.link.linkProjectDptName&&($scope.data.bindType=3,$(".new-del").show(),$scope.linkProject1=!1,$scope.linkComponent1=!1,$scope.linkCategoty1=!0)}))},function(){}):1==num?(layer.closeAll(),modalInstance=$uibModal.open({windowClass:"link-project-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/link_project.html",controller:"linkprojectCtrl"}),modalInstance.result.then(function(dataList){$scope.link.linkProjectName=dataList.linkProjectSelected.name,$scope.link.linkProjectDptName=dataList.parentNode.name,$scope.link.linkProjectDptName&&($(".new-del").show(),$scope.data.bindType=1,$scope.linkProject1=!0,$scope.linkComponent1=!1,$scope.linkCategoty1=!1),$scope.data.assembleLps=dataList.assembleLps,$scope.data.ppid=dataList.assembleLps[0].ppid,$scope.data.deptId=dataList.parentNode.value})):2==num?(modalInstance=$uibModal.open({windowClass:"link-component-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/link_component.html",controller:"linkcomponentCtrl"}),modalInstance.result.then(function(dataList){$scope.link.linkProjectDptName=dataList.parentNode.name,$scope.link.linkProjectName=dataList.linkProjectSelected.name,$scope.data.assembleLps=dataList.assembleLps,$scope.data.deptId=dataList.parentNode.value,$scope.data.ppid=dataList.assembleLps[0].ppid,$scope.link.linkProjectDptName&&($(".new-del").show(),$scope.data.bindType=2,$scope.linkProject1=!1,$scope.linkComponent1=!0,$scope.linkCategoty1=!1)})):3==num&&(modalInstance=$uibModal.open({windowClass:"link-categoty-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/link_component_category.html",controller:"linkprojectCtrl"}),modalInstance.result.then(function(dataList){$scope.link.linkProjectName=dataList.linkProjectSelected.name,$scope.link.linkProjectDptName=dataList.parentNode.name,$scope.linkProjectSelected=dataList.selectedCategory,$scope.data.assembleLps=dataList.assembleLps,$scope.data.deptId=dataList.parentNode.value,$scope.data.ppid=dataList.assembleLps[0].ppid,console.log("ppid",dataList.assembleLps.ppid),$scope.link.linkProjectDptName&&($scope.data.bindType=3,$(".new-del").show(),$scope.linkProject1=!1,$scope.linkComponent1=!1,$scope.linkCategoty1=!0)}))}function notScroll(){$(".new-mask").css("display","none"),$("body").css("overflow","")}var popStateNum=0,binds=[];if($scope.typeName=$stateParams.typename,$scope.isDoc=!1,$scope.priority="1",$scope.flag={},$scope.linkOpenSignal=!0,$scope.linkProject1=!1,$scope.linkComponent1=!1,$scope.linkCategoty1=!1,$scope.linkProjectClick=!1,$scope.linkComponentClick=!1,$scope.linkCategotyClick=!1,$scope.data={},$scope.link={},$scope.desc="",$scope.isClick=!0,$scope.responsiblePerson={},$scope.createUser={},$scope.beStates=!1,$scope.data.bindType=0,$scope.link.linkProjectName="",$scope.link.linkProjectDeptName="",$stateParams.deptId&&$stateParams.deptId!=-1&&0!=$stateParams.deptId){var currentdeptId=$stateParams.deptId?$stateParams.deptId:"",currentppid=$stateParams.ppid?$stateParams.ppid:"";$scope.link.linkProjectName=$stateParams.ppidName?$stateParams.ppidName:"",$scope.link.linkProjectDeptName=$stateParams.deptName?$stateParams.deptName:""}headerService.currentUserInfo().then(function(data){$scope.responsiblePerson.username=data.userName,$scope.responsiblePerson.avatar=data.avatarUrl,$scope.createUser=$scope.responsiblePerson;var relateUser={};relateUser.username=data.userName,relateUser.avatar=data.avatarUrl,relateUser.mustExist=!0,relateUser.canSign=!0,$scope.related.noSign[0]=relateUser}),Array.prototype.del=function(n){return n<0?this:this.slice(0,n).concat(this.slice(n+1,this.length))},$scope.link.linkProjectName&&currentppid&&($scope.data.deptId=$stateParams.deptId?$stateParams.deptId:"",$scope.data.ppid=$stateParams.ppid?$stateParams.ppid:"",$scope.data.bindType=1,binds[0]={ppid:currentppid,projType:currentdeptId});var modalInstance;$scope.selectResponsible=function(){modalInstance=$uibModal.open({windowClass:"select-person-responsible-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/select_person_responsible.html",controller:"selectpersonCtrl",resolve:{items:function(){return[]}}}),modalInstance.result.then(function(selectedItem){var responsiblePersonName=$scope.responsiblePerson.username;if(responsiblePersonName!=selectedItem.username){for(var signIndex=null,noSignIndex=null,i=0;i<$scope.related.sign.length;i++)if($scope.related.sign[i].username==responsiblePersonName){signIndex=i;break}for(var i=0;i<$scope.related.noSign.length;i++)if($scope.related.noSign[i].username==responsiblePersonName){noSignIndex=i;break}for(var i=0;i<$scope.related.sign.length;i++)if($scope.related.sign[i].username==selectedItem.username)return null!=signIndex&&responsiblePersonName!=$scope.createUser.username&&($scope.related.sign=$scope.related.sign.del(signIndex)),null!=noSignIndex&&responsiblePersonName!=$scope.createUser.username&&($scope.related.noSign=$scope.related.noSign.del(noSignIndex)),void($scope.responsiblePerson=selectedItem);for(var i=0;i<$scope.related.noSign.length;i++)if($scope.related.noSign[i].username==selectedItem.username)return null!=signIndex&&($scope.related.sign=$scope.related.sign.del(signIndex)),null!=noSignIndex&&($scope.related.noSign=$scope.related.noSign.del(noSignIndex)),void($scope.responsiblePerson=selectedItem);for(var i=0;i<$scope.related.sign.length;i++)if($scope.related.sign[i].username==responsiblePersonName&&responsiblePersonName!=$scope.createUser.username)return $scope.related.sign[i]=selectedItem,void($scope.responsiblePerson=selectedItem);for(var i=0;i<$scope.related.noSign.length;i++)if($scope.related.noSign[i].username==responsiblePersonName&&responsiblePersonName!=$scope.createUser.username)return $scope.related.noSign[i]=selectedItem,void($scope.responsiblePerson=selectedItem);$scope.related.noSign[$scope.related.noSign.length]=selectedItem,$scope.responsiblePerson=selectedItem}})},$scope.related={sign:[],noSign:[]};var contracts=[];$scope.selectRelated=function(){modalInstance=$uibModal.open({windowClass:"select-person-related-modal",backdrop:"static",animation:!1,size:"lg",templateUrl:"template/cooperation/select_person_related.html",controller:"selectpersonCtrl",resolve:{items:function(){for(var i=0;i<$scope.related.sign.length;i++)$scope.related.sign[i].username==$scope.responsiblePerson.username&&($scope.related.sign[i].mustExist=!0),$scope.related.sign[i].canSign=!0;for(var i=0;i<$scope.related.noSign.length;i++)$scope.related.noSign[i].username==$scope.responsiblePerson.username&&($scope.related.noSign[i].mustExist=!0),$scope.related.noSign[i].canSign=!0;return $scope.related}}}),modalInstance.result.then(function(selectedItem){$scope.related.noSign=selectedItem.noSign,$scope.related.sign=selectedItem.sign,contracts=[],angular.forEach(selectedItem.noSign,function(value,key){var needSign=!1,a={};a.needSign=needSign,a.username=value.username,contracts.push(a)}),angular.forEach(selectedItem.sign,function(value,key){var needSign=!0,a={};a.needSign=needSign,a.username=value.username,contracts.push(a)})})},Cooperation.getMarkerList().then(function(data){$scope.markerList=data,$scope.mark=$scope.markerList[0].markerId+"",data[0].markerId&&$timeout(function(){$(".selectpicker1").selectpicker({style:"",size:"auto"})},0)}),$scope.switchMark=function(){console.log($scope.mark)};$scope.linkProject=function(){$scope.linkProjectClick=!0,$scope.linkComponentClick=!1,$scope.linkCategotyClick=!1,isDelete(1)},$scope.linkComponent=function(){$scope.linkProjectClick=!1,$scope.linkComponentClick=!0,$scope.linkCategotyClick=!1,isDelete(2)},$scope.linkCategoty=function(){$scope.linkProjectClick=!1,$scope.linkComponentClick=!1,$scope.linkCategotyClick=!0,isDelete(3)},$scope.removeLink=function(){$scope.link.linkProjectName&&layer.confirm("您已关联了模型，是否删除关联？",{btn:["是","否"],move:!1},function(){$scope.linkProject1=!1,$scope.linkComponent1=!1,$scope.linkCategoty1=!1,$scope.link.linkProjectName=!1,$scope.data={},$scope.data.bindType=0,binds=[],layer.closeAll(),$scope.$apply()})},$scope.docSelectedList=[],$scope.formSelectedList=[];var typeArr=["txt","doc","pdf","ppt","docx","xlsx","xls","pptx","jpeg","bmp","PNG","GIF","JPG","png","jpg","gif","dwg","rar","zip","avi","mp4","mov","flv","swf","wmv","mpeg","mpg","mp3"];$scope.linkBe=function(){$scope.beStates=!1,$(".new-mask").hide(),notScroll(),$scope.beSourceType=1,$scope.flag.isleast=!1,modalInstance=$uibModal.open({windowClass:"link-be-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/linkbe.html",controller:"linkbeCtrl",resolve:{items:function(){return $scope.docSelectedList}}}),modalInstance.result.then(function(selectedItem1){var imgsrc="imgs/pro-icon/icon-",unit="";angular.forEach(selectedItem1,function(value,key){unit=typeArr.indexOf(value.fileType)!=-1?value.fileType:"other",selectedItem1[key].imgSrc=imgsrc+unit+".png"}),$scope.docSelectedList=selectedItem1,console.info("$scope.docSelectedList",$scope.docSelectedList.length)})},$scope.linkForm=function(){$scope.beStates=!1,$(".new-mask").hide(),notScroll(),$scope.formSourceType=2,$scope.flag.isleast=!1,modalInstance=$uibModal.open({windowClass:"link-form-modal",backdrop:"static",animation:!1,templateUrl:"template/cooperation/linkform.html",controller:"linkformCtrl",resolve:{items:function(){var trans={typeid:$stateParams.typeid,formSelectedList:$scope.formSelectedList};return trans}}}),modalInstance.result.then(function(selectedItem2){$scope.formSelectedList=selectedItem2,console.log("$scope.formSelectedList",$scope.formSelectedList.length)})},$scope.removePhoto=function(item){_.pull($scope.uploader.queue,item)},$scope.removeDoc=function(items){_.pull($scope.docSelectedList,items)},$scope.removeForm=function(items){_.pull($scope.formSelectedList,items)};var uploader=$scope.uploader=new FileUploader({url:basePath+"fileupload/upload.do"}),picturesUploadList=[],docsUploadList=[];$scope.flag.docsRepeatMind=!1,$scope.flag.pictrueRepeatMind=!1,uploader.filters.push({name:"imageFilter",fn:function(item,options){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return picturesUploadList.push(item),picturesUploadList.length>30?($scope.flag.pictrueRepeatMind||layer.alert("上传照片不能多于30个！",{title:"提示",closeBtn:0,move:!1}),$scope.flag.pictrueRepeatMind=!0,"|jpg|png|jpeg|bmp|gif|".indexOf(type)!==-1&&this.queue.length<30):"|jpg|png|jpeg|bmp|gif|".indexOf(type)!==-1&&this.queue.length<30}});var uploader1=$scope.uploader1=new FileUploader({url:basePath+"fileupload/upload.do"});uploader1.filters.push({name:"customFilter",fn:function(item,options){return docsUploadList.push(item),popStateNum++,docsUploadList.length>30?($scope.flag.docsRepeatMind||layer.alert("上传资料不能多于30个！",{closeBtn:0,move:!1}),$scope.flag.docsRepeatMind=!0,this.queue.length<30):this.queue.length<30}}),$scope.fileUpload=function(){$scope.flag.pictrueRepeatMind=!1,
$scope.flag.isleast=!1,$(".upload-img").attr("uploader","uploader"),$(".upload-img").attr("nv-file-select",""),$(".upload-img").click()},$scope.docsUpload=function(){$scope.beStates=!1,$(".new-mask").hide(),notScroll(),$scope.uploadSourceType=3,$scope.flag.isleast=!1,$scope.flag.docsRepeatMind=!1,$(".upload-docs").attr("uploader","uploader1"),$(".upload-docs").attr("nv-file-select",""),$(".upload-docs").click()},$scope.dateOptions={formatYear:"yy",maxDate:new Date(2020,5,22),startingDay:1,showWeeks:!1,minDate:new Date},$scope.open2=function(){$scope.popup2.opened=!0,$scope.isDeadlineNull=!1},$scope.popup2={opened:!1},$scope.checksignal=!1,$scope.isChecked=function(){$scope.checksignal=!$scope.checksignal,$scope.checksignal||($scope.dt=null)},$scope.dynamicPopover={templateUrl:"template/cooperation/mypopovertemplate.html"},$scope.changeTopic=function(){$scope.flag.nameToLong=!1},$scope.popBoxState=function(){$scope.beStates=!0,$(".new-mask").css("display","block"),$("body").css("overflow","hidden")},$(".new-mask").click(function(){$scope.beStates=!1,notScroll(),$(this).hide(),$scope.$apply()}),$scope.changeDesc=function(){$scope.flag.descToLong=!1};var docsList=[],uploadPictureList=[],uploadDocList=[],onCompleteAllSignal=!1;uploader.onAfterAddingFile=function(fileItem){var errorMessage="";fileItem.file.size<=0&&(errorMessage="文件错误，不能上传！"),fileItem.file.size>=5e7&&(errorMessage="文件大小超过50M限制！"),errorMessage&&(fileItem.remove(),layer.alert(errorMessage,{title:"提示",closeBtn:0,move:!1}))},uploader1.onAfterAddingFile=function(fileItem){var errorMessage="";fileItem.file.size<=0&&(errorMessage="文件错误，不能上传！"),fileItem.file.size>=5e7&&(errorMessage="文件大小超过50M限制！"),errorMessage&&(fileItem.remove(),layer.alert(errorMessage,{title:"提示",closeBtn:0,move:!1}))},$scope.save=function(status){function clearUploadInterval(){clearInterval(checkUploadInterval)}function saveCooperation(){var backJson=BimCo.SubmitAll();if(backJson&&(backJson=JSON.parse(backJson)),$scope.dt)var dt=Common.dateFormat($scope.dt);else dt="";var docSelectedList1=[],formSelectedList1=[];angular.forEach($scope.docSelectedList,function(value,key){var a={};if(backJson){var modifys=[];angular.forEach(backJson,function(value1,key1){if(value1&&key1==value.uuid){var i=0;for(i=0;i<value1.PdfModify.length;i++)modifys.push(value1.PdfModify[i])}})}a.modifys=modifys,a.md5=value.filemd5,a.name=value.docName,a.needSign=!1,a.uuid=value.uuid,a.size=value.filesize,a.sourceType=$scope.beSourceType,docSelectedList1.push(a)}),angular.forEach($scope.formSelectedList,function(value,key){var a={};if(backJson){var modifys=[];angular.forEach(backJson,function(value1,key1){if(value1&&key1==value.uuid){var i=0;for(i=0;i<value1.PdfModify.length;i++)modifys.push(value1.PdfModify[i])}})}a.modifys=modifys,a.md5=value.md5,a.name=value.name+"."+value.suffix,a.needSign=!0,a.uuid=value.uuid,a.size=value.size,a.sourceType=$scope.formSourceType,formSelectedList1.push(a)}),docsList=docSelectedList1.concat(formSelectedList1,uploadDocList),binds=2==$scope.data.bindType?[]:$scope.data.assembleLps?$scope.data.assembleLps:binds,$scope.data={binds:binds,bindType:$scope.data.bindType,collaborator:$scope.responsiblePerson.username,contracts:contracts,deadline:dt,deptId:$scope.data.deptId,desc:desc,docs:docsList,markerid:$scope.mark,name:$scope.coopname,pictures:uploadPictureList,ppid:$scope.data.ppid,priority:$scope.priority,status:status,typeId:$stateParams.typeid},console.log(JSON.stringify($scope.data)),console.log($scope.data);var obj=JSON.stringify($scope.data);Cooperation.createCollaboration(obj).then(function(data){layer.close(createindex);var coid=data;0==status?($scope.data.deptId=0,layer.msg("协作存入草稿箱成功！",{time:3e3})):1==status&&(binds.length||2===$scope.data.bindType||($scope.data.deptId=-1),layer.msg("创建协作成功",{time:3e3})),$state.go("cooperation",{deptId:$scope.data.deptId,ppid:$scope.data.ppid},{location:"replace"}),2==$scope.data.bindType&&BimCo.UpLoadComponent(coid),BimCo.CreateCoSucceed()},function(data){layer.close(createindex),$scope.flag.beginCreate=!1,obj=JSON.parse(data),layer.alert(obj.message,{title:"提示",closeBtn:0,move:!1})})}var desc=$("#desc").val();if($scope.flag.beginCreate=!0,1==status){if(!$scope.coopname)return void($scope.flag.isTopicNull=!0);if($scope.coopname.length>50)return void($scope.flag.nameToLong=!0);if($scope.flag.nameToLong=!1,$scope.desc.length>250)return void($scope.flag.descToLong=!0);if($scope.flag.descToLong=!1,$scope.coopname&&!uploader.queue.length&&!uploader1.queue.length&&!$scope.docSelectedList.length&&!$scope.formSelectedList.length)return $scope.flag.isTopicNull=!1,void($scope.flag.isleast=!0)}var createindex=layer.load(1,{shade:[.5,"#000"]});if(uploader.queue.length&&uploader1.queue.length){uploader.uploadAll();uploader.onSuccessItem=function(fileItem,response,status,headers){console.info("onSuccessItem",fileItem,response,status,headers);var unit={};unit.name=response[0].result.fileName,unit.md5=response[0].result.fileMd5,unit.size=response[0].result.fileSize,unit.uuid=response[0].result.uuid,uploadPictureList.push(unit)},uploader.onCompleteAll=function(){uploader1.uploadAll(),uploader1.onSuccessItem=function(fileItem,response,status,headers){console.info("onSuccessItem",fileItem,response,status,headers);var unit={};unit.name=response[0].result.fileName,unit.md5=response[0].result.fileMd5,unit.size=response[0].result.fileSize,unit.uuid=response[0].result.uuid,unit.sourceType=3,uploadDocList.push(unit)},uploader1.onCompleteAll=function(){onCompleteAllSignal=!0}}}if(uploader.queue.length&&!uploader1.queue.length){uploader.uploadAll();uploader.onSuccessItem=function(fileItem,response,status,headers){if("error"==response[0].type)return void layer.open({type:1,title:!1,closeBtn:0,shadeClose:!0,skin:"yourclass",move:!1,content:'<div class="tips">'+response[0].info+'</div><div class="tips_ok" onclick="layer.closeAll();">好</div>'});var unit={};unit.name=response[0].result.fileName,unit.md5=response[0].result.fileMd5,unit.size=response[0].result.fileSize,unit.uuid=response[0].result.uuid,uploadPictureList.push(unit)},uploader.onCompleteAll=function(){onCompleteAllSignal=!0}}if(!uploader.queue.length&&uploader1.queue.length){uploader1.uploadAll();uploader1.onSuccessItem=function(fileItem,response,status,headers){if("error"==response[0].type)return condole.log(response.info),void layer.open({type:1,title:!1,closeBtn:0,shadeClose:!0,skin:"yourclass",move:!1,content:'<div class="tips">'+response[0].info+'</div><div class="tips_ok"onclick="layer.closeAll();">好</div>'});var unit={};unit.name=response[0].result.fileName,unit.md5=response[0].result.fileMd5,unit.size=response[0].result.fileSize,unit.uuid=response[0].result.uuid,unit.sourceType=3,uploadDocList.push(unit)},uploader1.onCompleteAll=function(){onCompleteAllSignal=!0}}uploader.queue.length||uploader1.queue.length||saveCooperation();var checkUploadInterval=setInterval(function(){1==onCompleteAllSignal&&(clearUploadInterval(),saveCooperation())},100)};var currentDocSource="",currentDocIndex=0,currentEditOfficeUuid="",currentSuffix="",currentDocname="",currentReact="60,80,1200,720";$scope.isTypePdf=!1,$scope.preView=function(uuid,docName,fileType,index,docSource){if(currentEditOfficeUuid=uuid,currentDocname=docName,currentDocSource=docSource,currentDocIndex=index,"pdf"==fileType){var createindex=layer.load(1,{shade:[.5,"#000"]}),coid="",editResult=BimCo.PdfSign(currentEditOfficeUuid,currentSuffix,currentReact,coid);if(!editResult)return void layer.close(createindex);layer.close(createindex),$scope.flag.isPreview=!0,$scope.flag.isPdfsign=!0,$scope.flag.isGeneral=!1,$scope.isTypePdf=!0}else{$scope.isTypePdf=!1;var data={fileName:docName,uuid:uuid};Manage.getTrendsFileViewUrl(data).then(function(result){console.log(typeof result),$scope.flag.isPreview=!0,$scope.flag.isGeneral=!0,$scope.flag.isPdfsign=!1,$scope.previewUrl=$sce.trustAsResourceUrl(result)},function(data){$scope.flag.isPreview=!1,$scope.previewUrl="";var obj=JSON.parse(data);layer.alert(obj.message,{title:"提示",closeBtn:0,move:!1})})}},$scope.CommentSign=function(){$scope.isClick&&($(".edit-material").css("color","#c5c5c5"),$scope.isClick=!1,BimCo.CommentSign(currentEditOfficeUuid,currentSuffix))},$scope.saveOffice=function(){var coid="";if(!BimCo.IsModify())return void $scope.backCreate();var rtn=BimCo.MessageBox("提示","是否保存当前文档？",49);if(1==rtn){var isSuccess=BimCo.SignSubmit(coid);if(isSuccess)$scope.flag.isPreview=!1;else{$scope.flag.isPreview=!1;var rtn=BimCo.MessageBox("提示","保存失败！",0)}$scope.isClick=!0}},$scope.cancelEditOffice=function(){if(!BimCo.IsModify())return void $scope.backCreate();var rtn=BimCo.MessageBox("提示","放弃编辑？",49);1==rtn&&($scope.flag.isPreview=!1,BimCo.SignCancel(),$scope.isClick=!0)},$scope.backCreate=function(){if(BimCo.IsModify()){var rtn=BimCo.MessageBox("提示","放弃编辑？",49);1==rtn&&($scope.flag.isPreview=!1,BimCo.SignCancel(),$scope.isClick=!0)}else $scope.flag.isPreview=!1,$scope.isClick=!0,BimCo.SignCancel()},$scope.minimize=function(){BimCo.SysCommand("SC_MINIMIZE")},$scope.max=!0,$scope.maxRestore=function($event){BimCo.SysCommand("SC_MAXIMIZE")},$scope.close=function(){BimCo.SysCommand("SC_CLOSE")},$scope.cancelCreate=function(){layer.confirm("是否取消？",{btn:["是","否"],move:!1},function(){layer.closeAll(),BimCo.CancelSubmitAll(),$state.go("cooperation",{deptId:currentdeptId,ppid:currentppid,source:"rember"},{location:"replace"})})},$scope.backCooperation=function(){$state.go("cooperation",{deptId:currentdeptId,ppid:currentppid,source:"rember"},{location:"replace"})};var currentPage="create";$scope.checkFromBe=function(){var coid=$("#checkformbe").val();if("create"==currentPage){var rtn=BimCo.MessageBox("提示","当前正在创建中，是否跳转？",49);1==rtn&&($scope.flag.isPdfsign?(BimCo.SignCancel(),BimCo.CancelSubmitAll(),$state.go("coopdetail",{coid:coid})):$state.go("coopdetail",{coid:coid}))}},Cooperation.heartBeat(),$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){clearInterval(ApplicationConfiguration.refreshID),modalInstance&&modalInstance.dismiss()}),$scope.isNotPreview=function(){layer.msg("文件暂时不支持预览！",{time:2e3})}}]),angular.module("cooperation").controller("selectpersonCtrl",["$scope","$http","$uibModalInstance","Cooperation","items","$timeout",function($scope,$http,$uibModalInstance,Cooperation,items,$timeout){function defaultSelectedStyle(){var selectUsernames=[];angular.forEach($scope.relatedSelected,function(value2,key2){selectUsernames.push(value2.username)}),console.log(selectUsernames),angular.forEach($scope.userList,function(value,key){angular.forEach(value.users,function(value1,key1){console.log(value1);for(var i=0;i<selectUsernames.length;i++)if(selectUsernames[i]==value1.username){value1.select="block";break}})})}var defaultDeptId=1;$scope.selectedOption={},$scope.deptInfo={availableOptions:[]},$scope.userList=[],$scope.responsiblePerson="",$scope.trans_selected={noSign:[],sign:items.sign};var queryData={deptId:defaultDeptId,searchText:$scope.queryForm};Cooperation.getDeptList().then(function(data){$scope.deptInfo.availableOptions=data,$scope.selectedOption=data[0].deptId+"",defaultDeptId=data[0].deptId,queryData={deptId:defaultDeptId,searchText:$scope.queryForm},$timeout(function(){$(".selectpicker").selectpicker({style:"",size:"auto"})},300),Cooperation.getUserList(queryData).then(function(data){$scope.userList=data,defaultSelectedStyle()})}),$scope.switchUsers=function(params){queryData={deptId:params,searchText:$scope.queryForm},Cooperation.getUserList(queryData).then(function(data){$scope.userList=data,defaultSelectedStyle()}),$scope.queryForm?$scope.isCollapsed=!0:$scope.isCollapsed=!1},$scope.responsibleSearch=function(){queryData={deptId:$scope.selectedOption,searchText:$scope.queryForm},Cooperation.getUserList(queryData).then(function(data){$scope.userList=data,defaultSelectedStyle()}),$scope.queryForm?$scope.isCollapsed=!0:$scope.queryForm||($scope.isCollapsed=!1)},$scope.searchEnter=function(e){var keyCode=e.keyCode||e.which;13==keyCode?$scope.responsibleSearch():$scope.queryForm||($scope.responsibleSearch(),$scope.isCollapsed=!1)},$scope.changeStaus=function(id,pid,user){angular.forEach($scope.userList,function(value,key){for(var i=0;i<value.users.length;i++)key==pid&&i==id?value.users[i].add=!0:value.users[i].add=!1}),$scope.responsiblePerson=user};var temp=_.cloneDeep(items);if(temp.sign)var a=temp.sign.concat(temp.noSign);$scope.relatedSelected=a?a:[],$scope.addRelated=function(current){var currentUser={avatar:current.avatar,avatarUuid:current.uuid,isPassed:!1,isReaded:!1,isRejected:!1,isSigned:!1,needSign:!1,username:current.username,mustExist:!1,canSign:!0};$scope.relatedSelected.push(currentUser);var unique=_.uniqBy($scope.relatedSelected,"username");$scope.relatedSelected=unique,console.log("$scope.relatedSelected",$scope.relatedSelected)},$scope.removeRelated=function(current){var removeRelated=_.filter($scope.relatedSelected,function(o){return o.username!=current.username});angular.forEach($scope.userList,function(value,key){angular.forEach(value.users,function(value1,key1){value1.username===current.username&&value1.avatar===current.avatar&&$(".selected_"+key+"_"+key1).hide()})}),$scope.relatedSelected=removeRelated;var idx=signSelected.indexOf(current);idx!=-1&&signSelected.splice(idx,1)};var signSelected=temp.sign?temp.sign:[],nosignSelected=temp.noSign?temp.noSign:[],updateSelected=function(action,id){if("add"==action&&signSelected.indexOf(id)==-1&&(id.needSign=!0,signSelected.push(id),$scope.trans_selected.sign=signSelected),"remove"==action&&signSelected.indexOf(id)!=-1){id.needSign=!1;var idx=signSelected.indexOf(id);signSelected.splice(idx,1),$scope.trans_selected.sign=signSelected}};$scope.updateSelection=function($event,id){var checkbox=$event.target,action=checkbox.checked?"add":"remove";updateSelected(action,id)},$scope.isSelected=function(id){return signSelected.indexOf(id)>=0};var noSign=function(){signSelected.length?(nosignSelected=[],nosignSelected=_.difference($scope.relatedSelected,signSelected)):nosignSelected=$scope.relatedSelected};$scope.ok=function(){""!=$scope.responsiblePerson?$uibModalInstance.close($scope.responsiblePerson):layer.alert("请选择负责人",{title:"提示",closeBtn:0,move:!1})},$scope.ok1=function(){noSign(),$scope.trans_selected.noSign=nosignSelected,$uibModalInstance.close($scope.trans_selected)},$scope.allSelected=function(){$(".user-chioce").show(),$scope.flag.forbidAll=!0,angular.forEach($scope.userList,function(value,key){angular.forEach(value.users,function(value1,key1){var currentUser={avatar:value1.avatar,avatarUuid:value1.uuid,isPassed:!1,isReaded:!1,isRejected:!1,isSigned:!1,needSign:!1,username:value1.username,mustExist:!1,canSign:!0};$scope.relatedSelected.push(currentUser)})}),$scope.relatedSelected=_.uniqBy($scope.relatedSelected,"username")},$scope.delAll=function(){$(".user-chioce").hide();for(var noDelete=[],needSign=[],i=0;i<$scope.relatedSelected.length;i++)$scope.relatedSelected[i].mustExist&&(noDelete.push($scope.relatedSelected[i]),$scope.relatedSelected[i].needSign&&needSign.push($scope.relatedSelected[i]));$scope.relatedSelected=noDelete,$scope.trans_selected.sign=needSign,signSelected=needSign},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),angular.module("cooperation").controller("updatecommentCtrl",["$rootScope","$scope","$http","$state","$uibModalInstance","Cooperation","items","Common","FileUploader","$timeout",function($rootScope,$scope,$http,$state,$uibModalInstance,Cooperation,items,Common,FileUploader,$timeout){var onCompleteAllSignal=!1;switch($scope.uploadBegin=!1,$scope.zhenggai=!1,$scope.status=items.status,$scope.isUpdataOK=!1,$scope.status){case"空":$scope.status="11";break;case"已整改":$scope.status="1";break;case"整改中":$scope.status="2";break;case"不整改":$scope.status="3";break;case"待整改":$scope.status="4";break;case"未整改":$scope.status="5"}var coTypeVo=items.coTypeVo,isShowArr=["已结束","已通过","已拒绝"];1===coTypeVo&&isShowArr.indexOf($scope.status)==-1&&($scope.zhenggai=!0,$(".detail-state").show());var date=Common.dateFormat1(new Date),uploadList=[],uploadResult=!0,errorUpload="",uploader1=$scope.uploader1=new FileUploader({url:basePath+"fileupload/upload.do"});uploader1.filters.push({name:"customFilter",fn:function(item,options){return this.queue.length<31}}),$scope.docsUpload=function(){$(".upload-docs").attr("uploader","uploader1"),$(".upload-docs").attr("nv-file-select",""),$(".upload-docs").click()},uploader1.onAfterAddingFile=function(fileItem){var errorMessage="";fileItem.file.size<=0&&(errorMessage="文件错误，不能上传！"),fileItem.file.size>=5e7&&(errorMessage="文件大小超过50M限制！"),errorMessage&&(fileItem.remove(),layer.alert(errorMessage,{title:"提示",closeBtn:0}))},$scope.ok=function(){if(!$scope.comment)return void($scope.isUpdataOK=!0);var createindex=layer.load(1,{shade:[.5,"#000"]});$scope.status=parseInt($scope.status);var data={coid:items.coid,comment:{comment:$scope.comment,commentator:"",commentTime:date,docs:[]},status:$scope.status};uploader1.onSuccessItem=function(fileItem,response,status,headers){if("success"==response[0].type){var unit={};unit.name=response[0].result.fileName,unit.md5=response[0].result.fileMd5,unit.size=response[0].result.fileSize,unit.uuid=response[0].result.uuid,unit.suffix=response[0].result.suffix,uploadList.push(unit)}else"error"==response[0].type&&(uploadResult=!1,errorUpload+="<br/>",errorUpload+=fileItem.file.name)},uploader1.onErrorItem=function(item,response,status,headers){404==status&&(errorUpload="文件大小超过50M限制！"),uploadResult=!1},uploader1.onCompleteAll=function(){onCompleteAllSignal=!0,data.comment.docs=uploadList,uploadResult?Cooperation.commentToCollaboration(data).then(function(data){$state.go($state.current,{},{reload:!0})},function(data){layer.alert(data.message,{title:"提示",closeBtn:0,move:!1},function(index){$uibModalInstance.dismiss(),layer.closeAll()})}):(layer.close(createindex),layer.alert("以下文件上传失败："+errorUpload,{title:"提示",closeBtn:0},function(index){$uibModalInstance.dismiss()})),layer.close(createindex)},uploader1.queue.length?($scope.uploadBegin=!0,uploader1.uploadAll()):(layer.close(createindex),$uibModalInstance.close(data))},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.isNotPreview=function(){layer.msg("文件暂时不支持预览！",{time:2e3})}}]),angular.module("cooperation").service("Cooperation",function($http,$q){function getheartBeat(){var delay=$q.defer(),url_join=url+"rs/co/heartBeat";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise}function refreshState(){getheartBeat().then(function(){}),console.log("33")}var url=basePath;this.getDeptInfo=function(){var delay=$q.defer(),url_join=url+"rs/co/deptInfoList";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getDeptInfoList=function(params){var delay=$q.defer(),url_join=url+"rs/co/deptInfoList/"+params;return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(err){delay.reject(err)}),delay.promise},this.getProjectInfoList=function(params){var delay=$q.defer(),url_join=url+"rs/co/getProjectInfoList/"+params;return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(err){delay.reject(err)}),delay.promise},this.getDeptList=function(){var delay=$q.defer(),url_join=url+"rs/co/deptList";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getUserList=function(params){var delay=$q.defer(),url_join=url+"rs/co/pcUserList",params=JSON.stringify(params);return $http.post(url_join,params,{cache:!0,transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.projectList=function(params){var delay=$q.defer(),url_join=url+"rs/co/projectList/"+params;return $http.get(url_join,{cache:!1}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getProjectList=function(params){var delay=$q.defer(),url_join=url+"rs/co/projectInfoList/"+params;return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(err){delay.reject(err)}),delay.promise},this.getBVRectifyStatus=function(){var delay=$q.defer(),url_join=url+"rs/co/getBVRectifyStatus";return $http.get(url_join,{cache:!0}).success(function(data){delay.resolve(data)}).error(function(err){delay.reject(err)}),delay.promise},this.getCollaborationList=function(params){var params=JSON.stringify(params),delay=$q.defer(),url_join=url+"rs/co/collaborationList";return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getDocTagList=function(params){var delay=$q.defer(),url_join=url+"rs/co/docTagList/"+params;return $http.get(url_join).success(function(data){var allNode={name:"全部",value:"全部",type:1,children:data};delay.resolve(allNode)}).error(function(data){delay.reject(data)}),delay.promise},this.getDocList=function(params){var delay=$q.defer(),params=JSON.stringify(params),url_join=url+"rs/co/docList";return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getProjectTree=function(){var delay=$q.defer(),url_join=url+"rs/co/projectTree";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getFloorCompClassList=function(params){var delay=$q.defer(),url_join=url+"rs/co/floorCompClassList";return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getCollaboration=function(coid){var delay=$q.defer(),url_join=url+"rs/co/detail/"+coid;return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getTypeList=function(){var delay=$q.defer(),url_join=url+"rs/co/typeList";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getTemplateNode=function(params){var delay=$q.defer(),url_join=url+"rs/co/template/"+params+"/pdf";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.createCollaboration=function(params){var delay=$q.defer(),url_join=url+"rs/co/collaboration";return $http.post(url_join,params,{transformRequest:angular.identity,transformResponse:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getMarkerList=function(params){var delay=$q.defer(),url_join=url+"rs/co/markers";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getPriorityList=function(){var delay=$q.defer(),url_join=url+"rs/co/priorityList";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getProjTipInfo=function(params){var delay=$q.defer(),url_join=url+"rs/co/getProjTipInfo";return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getCoQueryFilter=function(params){var delay=$q.defer(),params=JSON.stringify({queryBvToPc:!0}),url_join=url+"rs/co/coQueryFilter";return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.updateCollaboration=function(params){var delay=$q.defer(),params=JSON.stringify(params),url_join=url+"rs/co/updateCollaboration";return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data,status){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getOperationList=function(coid){var delay=$q.defer(),url_join=url+"rs/co/operation/"+coid;return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.commentToCollaboration=function(params){var delay=$q.defer(),params=JSON.stringify(params),url_join=url+"rs/co/commentToCollaboration";return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getCurrentDate=function(){var cDate=new Date,cYear=cDate.getFullYear(),cMouth=cDate.getMonth()+1,cDay=cDate.getDate(),cWeekday=new Array(7);cWeekday[0]="星期日",cWeekday[1]="星期一",cWeekday[2]="星期二",cWeekday[3]="星期三",cWeekday[4]="星期四",cWeekday[5]="星期五",cWeekday[6]="星期六";var currentDate=cYear+"年"+cMouth+"月"+cDay+"日"+cWeekday[cDate.getDay()];return currentDate},this.getCoStatisticsInfo=function(params){var delay=$q.defer(),url_join=url+"rs/co/coStatistics",params=JSON.stringify(params);return $http.post(url_join,params,{transformRequest:angular.identity}).then(function(data){delay.resolve(data)},function(err){delay.reject(err)}),delay.promise},this.doCollaboration=function(params){var delay=$q.defer(),url_join=url+"rs/co/doCollaboration",params=JSON.stringify(params);return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getSignature=function(){var delay=$q.defer(),url_join=url+"rs/co/signature";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getTrendsSystem=function(params){var delay=$q.defer(),url_join=url+"rs/trends/system",obj=JSON.stringify(params);return $http.get(url_join,obj,{transformRequest:angular.identity}).then(function(data){delay.resolve(data)},function(err){delay.reject(err)}),delay.promise},this.checkIn=function(coid){var delay=$q.defer(),url_join=url+"rs/co/checkIn/"+coid,params=JSON.stringify(params);return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.checkOut=function(coid){var params,delay=$q.defer(),url_join=url+"rs/co/checkOut/"+coid;return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.checkCoLocked=function(coid){var delay=$q.defer(),url_join=url+"rs/co/checkCoLocked/"+coid,params=JSON.stringify(params);return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.removeDraft=function(coid){var params,delay=$q.defer(),url_join=url+"rs/co/removeDraft/"+coid;return $http.get(url_join,params,{transformRequest:angular.identity}).then(function(data){delay.resolve(data)},function(err){delay.reject(err)}),delay.promise},this.getCurrentUser=function(){var delay=$q.defer(),url_join=url+"rs/co/currentUser";return $http.get(url_join,{},{transformRequest:angular.identity,transformResponse:angular.identity}).then(function(data){delay.resolve(data)},function(err){delay.reject(err)}),delay.promise},this.getOrgInfo=function(){var delay=$q.defer(),url_join=url+"rs/co/orgInfo";return $http.get(url_join,{},{transformRequest:angular.identity,transformResponse:angular.identity}).success(function(data){delay.resolve(data)}).error(function(err){delay.reject(err)}),delay.promise},this.heartBeat=function(){ApplicationConfiguration.refreshID=setInterval(refreshState,12e5)},this.openOrClose=function(e){for(var level=e.level,type=e.type,operObj=e.operObj,zTree=$.fn.zTree.getZTreeObj(operObj),treeNodes=zTree.transformToArray(zTree.getNodes()),flag=!0,maxLevel=-1,i=0;i<treeNodes.length;i++)if(treeNodes[i].level>=maxLevel&&(maxLevel=treeNodes[i].level),treeNodes[i].level==level&&treeNodes[i].isParent){if("expand"==type&&!treeNodes[i].open){flag=!1;break}if("collapse"==type&&treeNodes[i].open){flag=!1;break}}if(flag)if("expand"==type)level<maxLevel-1&&level++;else if("collapse"==type){if(0==level)return level;level--}for(var i=0;i<treeNodes.length;i++)treeNodes[i].level==level&&treeNodes[i].isParent&&("expand"!=type||treeNodes[i].open?"collapse"==type&&treeNodes[i].open&&zTree.expandNode(treeNodes[i],!1,!1,null,!0):zTree.expandNode(treeNodes[i],!0,!1,null,!0));return level},this.expandAll=function(treeId){var treeObj=$.fn.zTree.getZTreeObj(treeId);treeObj.expandAll(!0);for(var treeNodes=treeObj.transformToArray(treeObj.getNodes()),i=0;i<treeNodes.length;i++)treeNodes[i].level>=maxLevel&&(maxLevel=treeNodes[i].level);return maxLevel},this.getPcMp3Url=function(uuid){var delay=$q.defer(),url_join=url+"rs/co/downFileUrl",params=JSON.stringify(uuid);return $http.post(url_join,params,{transformRequest:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise}}),ApplicationConfiguration.registerModule("manage"),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/cooperation"),$stateProvider.state("manage",{url:"/manage",templateUrl:"template/manage/manage.html",controller:"manageCtrl",data:{displayName:"manage"},params:{deptId:null,ppid:null}})}]),angular.module("manage").controller("manageCtrl",["$scope","$http","$uibModal","$state","FileUploader","Manage","$stateParams","Cooperation","$sce",function($scope,$http,$uibModal,$state,FileUploader,Manage,$stateParams,Cooperation,$sce){function getimgurl(treeItems,deptId){$("#dept_"+deptId).empty();for(var i=0;i<treeItems.length;i++)"土建预算"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/1.png":"钢筋预算"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/2.png":"安装预算"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/3.png":"Revit"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/4.png":"Tekla"==treeItems[i].projectType?treeItems[i].imgsrc="imgs/icon/5.png":"PDF"==treeItems[i].projectType&&(treeItems[i].imgsrc="imgs/icon/6.png"),treeItems[i].count?$("#dept_"+deptId).append("<span id=projectbutton_"+treeItems[i].ppid+" title='"+treeItems[i].projectName+"' class='spanwidth'><img src='"+treeItems[i].imgsrc+"'><span class='substr-sideMenus coop-menusSet' style='display:inline-block;'>"+treeItems[i].projectName+"</span>&nbsp;<b class='coop-countElement'>("+treeItems[i].count+")</b></span>"):$("#dept_"+deptId).append("<span id=projectbutton_"+treeItems[i].ppid+" title='"+treeItems[i].projectName+"' class='spanwidth'><img src='"+treeItems[i].imgsrc+"'><span class='substr-sideMenus coop-menusSet' style='display:inline-block;'>"+treeItems[i].projectName+"</span></span>");$("span[id^='projectbutton_']").bind("click",function(){$scope.isNoSearchValue=!1,$scope.isNoSearchValueBook=!1,$(".manage-menus").removeClass("menusActive"),$("span").removeClass("menusActive"),$(this).addClass("menusActive").siblings().removeClass("menusActive"),$(" .data_count").hide(),$scope.trentsListInfo=[],changeProj=!0,$scope.trentsList($(this).attr("id").split("_")[1])})}var firstdeptid,firstreackflag=!0,searchId=$stateParams.ppid?$stateParams.ppid:"",deptId=$stateParams.deptId?$stateParams.deptId:"",changeProj=!1;$scope.flag={},$scope.docType="1",$scope.deptInfoList=[],$scope.projectInfoList=[],$scope.openSignal=!1,$scope.isNoSearchValue=!1,$scope.isNoSearchValueBook=!1,$scope.isNoSearchValueReject=!1,$scope.isShowProList=!1,sessionStorage.clear(),$scope.openNew=function(){$scope.openSignal=!0},$scope.closeNew=function(){$scope.openSignal=!1;
},$scope.trans=function(){var url=$state.href("newcopper",{parameter:"parameter"});window.open(url,"_blank")};var searchBox=$("#exampleInputName2").val();Manage.getDeptInfoList().then(function(data){$scope.deptInfoList=data,deptId||(firstdeptid=data[0].deptId)}),$scope.initScrollend=function(id){searchId!=id&&($scope.scrollend=!1,lastUploadTime="",lastUsername="")},$scope.childItems=function(id,$event,open){var createindex=layer.load(1,{shade:[.5,"#000"]}),searchBox=$("#exampleInputName2").val();if($(".good_list").show(),$(".pro_list").hide(),$(".goodlist_left").show(),$(".prolist_left").hide(),$(".manage-menus").removeClass("menusActive"),$("span.spanwidth").removeClass("menusActive"),$scope.isNoSearchValueReject=!1,$scope.isNoSearchValue&&$(".good_list").css({display:"none"}),open)layer.close(createindex);else{Manage.getProjectInfoList(id).then(function(data){getimgurl(data,id),void 0!=data.data&&(0==data.data.length?($scope.isNoSearchValue=!0,$scope.isNoSearchValueReject=!1,$(".good_list").css({display:"none"})):($scope.isNoSearchValue=!1,$(".good_list").css({display:"block"}),$(".pro_list").css({display:"none"})))}),deptId=id;var params={deptId:id,searchText:searchBox},obj=JSON.stringify(params);$scope.isNoSearchValue=!1,$scope.isNoSearchValueReject=!1,Manage.getProjectTrends(obj).then(function(data){layer.close(createindex),$scope.trentsCount=data.data,0==data.data.length?(""==params.searchText?$scope.isNoSearchValue=!0:$scope.isNoSearchValueReject=!0,$(".good_list").css({display:"none"})):($scope.isNoSearchValue=!1,$(".good_list").css({display:"block"}),$(".pro_list").css({display:"none"}))})}deptId||(deptId=deptId),deptId!=deptId&&(deptId=deptId)},$scope.searchProject=function(deptId,searchBox){$scope.isNoSearchValue=!1,$scope.isNoSearchValueReject=!1;var params={deptId:deptId,searchText:searchBox},obj=JSON.stringify(params);Manage.getProjectTrends(obj).then(function(data){$scope.trentsCount=data.data,0==$scope.trentsCount.length?($scope.isNoSearchValueReject=!0,$(".good_list").css({display:"none"})):($scope.isNoSearchValueReject=!1,$(".good_list").css({display:"block"}))})},$scope.getDeptId=function(){deptId=deptId?deptId:firstdeptid;var searchBox=$("#exampleInputName2").val();searchBox.length>0?$scope.searchProject(deptId,searchBox):0==searchBox.length&&(deptId=deptId?deptId:firstdeptid,searchBox="",$scope.searchProject(deptId,searchBox))},$scope.$on("ngRepeatFinished",function(ngRepeatFinishedEvent){function switchi(){slideindex==slid.length-1?slideindex=0:slideindex+=1,slid.addClass("none"),slid.eq(slideindex).removeClass("none")}function options(indexs){slid.addClass("none"),slid.eq(indexs).removeClass("none")}var slid=$("ul.slide_box li");slid.addClass("none"),slid.eq(0).removeClass("none");var slideindex=0,timer=setInterval(switchi,3e3);$("a.options").click(function(){var drec=$(this).data("drec");"pre"==drec?0==slideindex?slideindex=3:slideindex-=1:3==slideindex?slideindex=0:slideindex+=1,clearInterval(timer),options(slideindex)}),$("ul > li >.bx-controls >.img_list>.tools_bar>.bookSection").click(function(){slideindex=$(this).index(),clearInterval(timer),options(slideindex),$(".mask").show(),$(".showImg").show(),$(".turnDown").show()}),$(".turnDown").click(function(){$(this).hide(),$(".mask").hide(),$(".showImg").hide()}),$(".pro-down").click(function(){$(".tools_bar>.pro_mask").animate({top:0}),$(".bar").hide()}),$(".proName").click(function(){$(this).find(".panel-body").height()<=20&&$(this).find(".panel-body").css("padding-bottom","0px")}),$(".manage-menus").bind("click",function(){$("manage-menus").removeClass("menusActive"),$(this).addClass("menusActive").siblings().removeClass("menusActive")}),$(".tools_bar").mouseenter(function(){$(this).find(".bar").stop().animate({bottom:"0"},200)}),$(".tools_bar").mouseleave(function(){$(this).find(".bar").stop().animate({bottom:"-28px"},200)})}),$scope.trentsSearch=function(seacherKey){Manage.getTrends({count:10,lastUploadTime:"",lastUsername:"",ppid:searchId,searchKey:seacherKey,searchType:$scope.docType}).then(function(data){$scope.trentsListInfo=data.data;var typeArr=["txt","doc","pdf","ppt","docx","xlsx","xls","pptx","jpeg","bmp","PNG","GIF","JPG","TXT","DOC","PDF","PPT","DOCX","XLSX","PPTX","JPEG","BMP","png","jpg","gif","dwg","rar","zip","avi","mp4","mov","flv","swf","wmv","mpeg","mpg","mp3"];angular.forEach(data.data,function(value,key){angular.forEach(value.docs,function(value1,key1){typeArr.indexOf(value1.fileType)==-1&&($scope.trentsListInfo[key].docs[key1].fileType="other")})}),0==data.data.length?($scope.isNoSearchValueReject=!0,$(".pro_list").css("display","none")):($scope.isNoSearchValueReject=!1,$(".pro_list").css("display","block"))})},$scope.manageSeacher=function(){$scope.trentsListInfo=[],$scope.seacherKey=$("#exampleInputName3").val(),$scope.docType?$scope.docType=$scope.docType:$scope.docType="1",$scope.trentsSearch($scope.seacherKey)},$scope.changeAttr=function(docType){$scope.scrollend=!1,lastUploadTime="",lastUsername="",$scope.trentsListInfo=[],$scope.seacherKey=$("#exampleInputName3").val(),$scope.docType?$scope.docType=$scope.docType:$scope.docType=1,$scope.addMoreData()},$("#exampleInputName2").val(),$scope.previewList=function(e){var keyCode=e.keyCode||e.which;""!=$("#exampleInputName2").val()&&13==keyCode?$scope.getDeptId():""==$("#exampleInputName2").val()&&($scope.trentsCount=[],searchBox=$("#exampleInputName2").val(),searchBox="",deptId=deptId?deptId:firstdeptid,$scope.searchProject(deptId,searchBox))},$scope.keyUp=function(e){var keyCode=e.keyCode||e.which;if(""!=$("#exampleInputName3").val()&&13==keyCode)$scope.seacherKey=$("#exampleInputName3").val(),$scope.manageSeacher();else if(""==$("#exampleInputName3").val()){""==$("#exampleInputName3").val();var searchValue=$("#exampleInputName3").val();$scope.trentsListInfo=[],$scope.trentsSearch(searchValue),$scope.isNoSearchValueReject=!1}};var searchFlag,checkSearchInterval,pollingFlag=!0;$scope.addMoreData=function(){$scope.tokenBack&&(changeProj?changeProj=!1:(setSearchFlagFalse(),pollingFlag&&(pollingFlag=!1,checkSearchInterval=setInterval(function(){checkCanSearch()},100)),setTimeout(function(){setSearchFlagTrue()},150)))};var lastUploadTime,lastUsername,setSearchFlagFalse=function(){searchFlag=!1},setSearchFlagTrue=function(){searchFlag=!0},checkCanSearch=function(){searchFlag&&(clearInterval(checkSearchInterval),$scope.trentsList(searchId),pollingFlag=!0)};$scope.trentsListInfo=[],$scope.scrollend=!1,$scope.turnPage=function(id){$("span[id='projectbutton_"+id+"']").click()},$scope.trentsList=function(id){if($scope.tokenBack=!0,searchId!=id&&($scope.trentsListInfo=[]),$scope.isNoSearchValueReject=!1,$(".manage-menus").removeClass("menusActive"),changeProj&&($scope.scrollend=!1,lastUploadTime="",lastUsername=""),id){searchId=id,$(".good_list").hide(),$(".pro_list").show(),$(".goodlist_left").hide(),$(".prolist_left").show();var createindex=layer.load(1,{shade:[.5,"#000"]});$scope.seacherKey=$("#exampleInputName3").val(),$scope.docType?$scope.docType=$scope.docType:$scope.docType=1,Manage.getTrends({count:10,lastUploadTime:lastUploadTime,lastUsername:lastUsername,ppid:id,searchKey:$scope.seacherKey,searchType:$scope.docType}).then(function(data){var size=0;if(0!=data.data.length){for(var i=0;i<data.data.length;i++)size++,$scope.trentsListInfo.push(data.data[i]);lastUploadTime=data.data[data.data.length-1].updateTime,lastUsername=data.data[data.data.length-1].username}0==$scope.trentsListInfo.length?($(".pro_list").css("display","none"),$scope.isNoSearchValueReject=!0):($scope.isNoSearchValueReject=!1,$(".pro_list").css("display","block")),data.data.length<10&&($scope.scrollend=!0);var lh=0;$scope.trentsListInfo.length>10&&(lh=$scope.trentsListInfo.length-size);var typeArr=["txt","doc","pdf","ppt","docx","xlsx","xls","pptx","jpeg","bmp","PNG","GIF","JPG","TXT","DOC","PDF","PPT","DOCX","XLSX","PPTX","JPEG","BMP","png","jpg","gif","dwg","rar","zip","avi","mp4","mov","flv","swf","wmv","mpeg","mpg","mp3"];angular.forEach(data.data,function(value,key){angular.forEach(value.docs,function(value1,key1){if(typeArr.indexOf(value1.fileType)==-1){var keys=lh+key;$scope.trentsListInfo[keys].docs[key1].fileType="other"}})}),layer.close(createindex)}),$scope.id=id}},$scope.getProjectList=function(index){$scope.isOpen=!$scope.isOpen},$scope.transformBig=function(uuid,docName,isPreview){var data={fileName:docName,uuid:uuid};return 0==isPreview?void layer.alert("该文件暂不支持预览",{title:"提示",closeBtn:0}):void Manage.getTrendsFileViewUrl(data).then(function(result){console.log(typeof result),$scope.flag.isPreview=!0,$scope.previewUrl=$sce.trustAsResourceUrl(result)},function(data){var obj=JSON.parse(data);layer.alert(obj.message,{title:"提示",closeBtn:0})})},$scope.tokenBack=!1,$scope.listBack=function(){$scope.tokenBack=!1,$state.go("manage",{deptId:deptId,ppid:searchId},{location:!0}),$(".good_list").show(),$(".pro_list").hide(),$(".goodlist_left").show(),$(".prolist_left").hide(),$scope.scrollend=!0},$scope.$on("shadowFinsh",function(ngRepeatFinishedEvent){$scope.updataBook=function(adds){adds=adds,adds>0&&adds--,$(".good_list dl").click(function(){$(this).find(".updateNub").text(adds),$(this).addClass("dlActive").siblings().removeClass("dlActive")})}}),$scope.$on("ngRepeatFinishedDept",function(ngRepeatFinishedEvent){firstreackflag&&(deptId?$("#deptbutton_"+deptId).click():$("#deptbutton_"+firstdeptid).click(),firstreackflag=!1)}),$scope.backManage=function(){$scope.flag.isPreview=!1},$scope.transCooperation=function(){$state.go("cooperation",{transignal:"be"})},Cooperation.heartBeat(),$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){clearInterval(ApplicationConfiguration.refreshID),layer.closeAll()}),$scope.minimize=function(){BimCo.SysCommand("SC_MINIMIZE")},$scope.maxRestore=function(){BimCo.SysCommand("SC_MAXIMIZE")},$scope.close=function(){BimCo.SysCommand("SC_CLOSE")}}]),angular.module("manage").service("Manage",function($http,$q){var trendUrl=basePath;this.getDeptInfoList=function(){var delay=$q.defer(),url_join=trendUrl+"rs/trends/deptInfoList";return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getProjectInfoList=function(params){var delay=$q.defer(),url_join=trendUrl+"rs/trends/projectInfoList/"+params;return $http.get(url_join).success(function(data){delay.resolve(data)}).error(function(data,status){delay.reject(data)}),delay.promise},this.getProjectTrends=function(obj){var delay=$q.defer(),url_join=trendUrl+"rs/trends/projectTrends";return $http.post(url_join,obj,{transformRequest:angular.identity}).then(function(data){delay.resolve(data)},function(data){delay.resolve(data)}),delay.promise},this.getTrends=function(params){var delay=$q.defer(),url_join=trendUrl+"rs/trends/trends",obj=JSON.stringify(params);return $http.post(url_join,obj,{transformRequest:angular.identity}).then(function(data){delay.resolve(data)},function(data){delay.reject(data)}),delay.promise},this.getTrendsFileViewUrl=function(params){var params=JSON.stringify(params),delay=$q.defer(),url_join=trendUrl+"rs/trends/viewUrl";return $http.post(url_join,params,{transformRequest:angular.identity,transformResponse:angular.identity}).success(function(data){delay.resolve(data)}).error(function(data){delay.reject(data)}),delay.promise},this.getCurrentDate=function(){var cDate=new Date,cYear=cDate.getFullYear(),cMouth=cDate.getMonth()+1,cDay=cDate.getDate(),cWeekday=new Array(7);cWeekday[0]="星期日",cWeekday[1]="星期一",cWeekday[2]="星期二",cWeekday[3]="星期三",cWeekday[4]="星期四",cWeekday[5]="星期五",cWeekday[6]="星期六";var currentDate=cYear+"年"+cMouth+"月"+cDay+"日"+cWeekday[cDate.getDay()];return currentDate},this.getTrendsSystem=function(params){var delay=$q.defer(),url_join=trendUrl+"rs/trends/system",obj=JSON.stringify(params);return $http.get(url_join,obj,{transformRequest:angular.identity}).then(function(data){delay.resolve(data)},function(err){delay.reject(err)}),delay.promise}}),function($){$.fn.scrollLoading=function(options){var defaults={attr:"data-url",container:$(window),callback:$.noop},params=$.extend({},defaults,options||{});params.cache=[],$(this).each(function(){var node=this.nodeName.toLowerCase(),url=$(this).attr(params.attr),data={obj:$(this),tag:node,url:url};params.cache.push(data)});var callback=function(call){$.isFunction(params.callback)&&params.callback.call(call.get(0))},loading=function(){var contop,contHeight=params.container.height();contop=$(window).get(0).window===window?$(window).scrollTop():params.container.offset().top,$.each(params.cache,function(i,data){var post,posb,o=data.obj,tag=data.tag,url=data.url;o&&(post=o.offset().top-contop,post+o.height(),(o.is(":visible")&&post>=0&&post<contHeight||posb>0&&posb<=contHeight)&&(url?"img"===tag?callback(o.attr("src",url)):o.load(url,{},function(){callback(o)}):callback(o),data.obj=null))})};loading(),params.container.bind("scroll",loading)}}(jQuery);